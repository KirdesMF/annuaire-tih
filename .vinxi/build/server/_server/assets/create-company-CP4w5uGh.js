import{eq as p}from"drizzle-orm";import{c as g,d as m}from"./index-8Htcofqc.js";import{c as i}from"./companies-l5PKOmvG.js";import{C as d}from"./company.schema-C_XODBeq.js";import*as y from"valibot";import{c as f}from"./company-categories-CgBd9Wjc.js";import{u as _}from"./cloudinary-BTIR3bRv.js";import{decode as w}from"decode-formdata";import{customAlphabet as h}from"nanoid";import{createServerFn as C}from"@tanstack/start-client-core";import"tiny-invariant";import"drizzle-orm/postgres-js";import"postgres";import"dotenv";import"drizzle-orm/pg-core";import"./auth-BsEI6_U5.js";import"./categories-B1A9pQfz.js";import"cloudinary";const b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",v=h(b,10);function S(e,r=50){return e.normalize("NFKD").toLowerCase().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"").slice(0,r).replace(/-+$/g,"")}function I(e){return`${S(e)}-${v()}`}async function l({images:e,companyId:r,companySlug:o,type:c}){const s=[];for(const t of e){const a=await _({file:t,companyId:r,companySlug:o,type:c});if(a instanceof Error)throw a;const{secure_url:n,public_id:u}=a;s.push({secureUrl:n,publicId:u})}return s}async function F(e,r){await m.insert(f).values(r.map(o=>({company_id:e,category_id:o})))}async function T(e){const[r]=await m.insert(i).values({...e,created_by:e.user_id,slug:I(e.name)}).returning();return r}const q=g("app_lib_api_companies_mutations_create-company_ts--createCompany_createServerFn_handler","/_server",(e,r)=>$.__executeServer(e,r)),$=C({method:"POST"}).validator(e=>{const r=w(e,{files:["logo","gallery"],arrays:["categories","gallery"],booleans:["rqth"]});return y.parse(d,r)}).handler(q,async({data:e})=>{const{logo:r,gallery:o,categories:c,...s}=e;try{await m.transaction(async t=>{const a=await T(s);if(await F(a.id,c),r&&r.size>0){const n=await l({type:"logo",images:[r],companyId:a.id,companySlug:a.slug});await t.update(i).set({logo:n[0]}).where(p(i.id,a.id))}if(o&&o.length>0){const n=await l({type:"gallery",images:o,companyId:a.id,companySlug:a.slug});await t.update(i).set({gallery:n}).where(p(i.id,a.id))}})}catch(t){console.error(t)}});export{q as createCompany_createServerFn_handler};
