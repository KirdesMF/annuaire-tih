import{EventEmitter as e}from"node:events";import{Buffer as t}from"node:buffer";import r from"node:stream";import{bp as n,bq as s,br as o,bs as a,bt as i,bu as c,bv as l,bw as u,bx as f,by as d,bz as p,bA as m,bB as h,bC as g,bD as y,bE as E,bF as w,Q as b}from"../nitro/nitro.mjs";import{f as v}from"./server.mjs";import*as S from"node:path";const _=globalThis.crypto;let O=1;const I=new Set,P="(?:[0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])",N=`(${P}[.]){3}${P}`,T=new RegExp(`^${N}$`),A="(?:[0-9a-fA-F]{1,4})",R=new RegExp(`^((?:${A}:){7}(?:${A}|:)|(?:${A}:){6}(?:${N}|:${A}|:)|(?:${A}:){5}(?::${N}|(:${A}){1,2}|:)|(?:${A}:){4}(?:(:${A}){0,1}:${N}|(:${A}){1,3}|:)|(?:${A}:){3}(?:(:${A}){0,2}:${N}|(:${A}){1,4}|:)|(?:${A}:){2}(?:(:${A}){0,3}:${N}|(:${A}){1,5}|:)|(?:${A}:){1}(?:(:${A}){0,4}:${N}|(:${A}){1,6}|:)|(?::((?::${A}){0,5}:${N}|(?::${A}){1,7}|:)))(%[0-9a-zA-Z-.:]{1,})?$`),D=new TextEncoder,crypto$1_randomBytes=e=>_.getRandomValues(t.alloc(e)),crypto$1_pbkdf2Sync=async(e,t,r,n)=>_.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:t,iterations:r},await _.subtle.importKey("raw",D.encode(e),"PBKDF2",!1,["deriveBits"]),8*n,["deriveBits"]),crypto$1_createHash=e=>({update:r=>({digest:n=>{let s;if(r instanceof Uint8Array||(r=D.encode(r)),"sha256"===e)s=_.subtle.digest("SHA-256",r);else{if("md5"!==e)throw Error("createHash only supports sha256 or md5 in this environment, not ${type}.");s=_.subtle.digest("md5",r)}if("hex"===n)return s.then((e=>t.from(e).toString("hex")));if(n)throw Error(`createHash only supports hex encoding or unencoded in this environment, not ${n}`);return s}})}),crypto$1_createHmac=(e,r)=>({update:e=>({digest:async()=>t.from(await _.subtle.sign("HMAC",await _.subtle.importKey("raw",r,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),D.encode(e)))})}),C=globalThis.performance,x={env:{}},L={userInfo:()=>({username:"postgres"})},U={readFile(){throw new Error("Reading files not supported on CloudFlare")}},k={isIP:e=>T.test(e)?4:R.test(e)?6:0,Socket:function(){const r=Object.assign(new e,{readyState:"open",raw:null,writer:null,reader:null,connect:async function(e,n){try{r.readyState="opening";const{connect:s}=await import("cloudflare:sockets");r.raw=s(n+":"+e,r.ssl?{secureTransport:"starttls"}:{}),r.raw.closed.then((()=>{"upgrade"!==r.readyState?function(){if("closed"===r.readyState)return;r.readyState="closed",r.emit("close")}():(r.readyState="open",r.emit("secureConnect"))}),(e=>r.emit("error",e))),r.writer=r.raw.writable.getWriter(),r.reader=r.raw.readable.getReader(),r.ssl?async function(){const{value:e}=await r.reader.read();r.emit("data",t.from(e))}():read(),r.writer.ready.then((()=>{r.readyState="open",r.emit("connect")}))}catch(e){error(e)}},write:function(e,t){return r.writer.write(e).then(t,error),!0},end:function(e){return e?r.write(e,(()=>r.raw.close())):r.raw.close()},destroy:function(){r.destroyed=!0,r.end()},read:read});return r;async function read(){try{let e,n;for(;({done:e,value:n}=await r.reader.read()),!e;)r.emit("data",t.from(n))}catch(e){error(e)}}function error(e){r.emit("error",e),r.emit("close")}}},$={connect:({socket:e,servername:t})=>(e.writer.releaseLock(),e.reader.releaseLock(),e.readyState="upgrading",e.raw=e.raw.startTls({servername:t}),e.raw.closed.then((()=>e.emit("close")),(t=>e.emit("error",t))),e.writer=e.raw.writable.getWriter(),e.reader=e.raw.readable.getReader(),e.writer.ready.then((()=>{e.read(),e.readyState="upgrade"})),e)};function clearImmediate(e){I.delete(e)}const B=new Map,z=new Map,M=Symbol("OriginError"),j={};class Query extends Promise{constructor(e,t,r,n,s={}){let o,a;super(((e,t)=>{o=e,a=t})),this.tagged=Array.isArray(e.raw),this.strings=e,this.args=t,this.handler=r,this.canceller=n,this.options=s,this.state=null,this.statement=null,this.resolve=e=>(this.active=!1,o(e)),this.reject=e=>(this.active=!1,a(e)),this.active=!1,this.cancelled=null,this.executed=!1,this.signature="",this[M]=this.handler.debug?new Error:this.tagged&&function(e){if(B.has(e))return B.get(e);const t=Error.stackTraceLimit;return Error.stackTraceLimit=4,B.set(e,new Error),Error.stackTraceLimit=t,B.get(e)}(this.strings)}get origin(){return(this.handler.debug?this[M].stack:this.tagged&&z.has(this.strings)?z.get(this.strings):z.set(this.strings,this[M].stack).get(this.strings))||""}static get[Symbol.species](){return Promise}cancel(){return this.canceller&&(this.canceller(this),this.canceller=null)}simple(){return this.options.simple=!0,this.options.prepare=!1,this}async readable(){return this.simple(),this.streaming=!0,this}async writable(){return this.simple(),this.streaming=!0,this}cursor(e=1,t){if(this.options.simple=!1,"function"==typeof e&&(t=e,e=1),this.cursorRows=e,"function"==typeof t)return this.cursorFn=t,this;let r;return{[Symbol.asyncIterator]:()=>({next:()=>{if(this.executed&&!this.active)return{done:!0};r&&r();const e=new Promise(((e,t)=>{this.cursorFn=t=>(e({value:t,done:!1}),new Promise((e=>r=e))),this.resolve=()=>(this.active=!1,e({done:!0})),this.reject=e=>(this.active=!1,t(e))}));return this.execute(),e},return:()=>(r&&r(j),{done:!0})})}}describe(){return this.options.simple=!1,this.onlyDescribe=this.options.prepare=!0,this}stream(){throw new Error(".stream has been renamed to .forEach")}forEach(e){return this.forEachFn=e,this.handle(),this}raw(){return this.isRaw=!0,this}values(){return this.isRaw="values",this}async handle(){!this.executed&&(this.executed=!0)&&await 1&&this.handler(this)}execute(){return this.handle(),this}then(){return this.handle(),super.then.apply(this,arguments)}catch(){return this.handle(),super.catch.apply(this,arguments)}finally(){return this.handle(),super.finally.apply(this,arguments)}}class PostgresError extends Error{constructor(e){super(e.message),this.name=this.constructor.name,Object.assign(this,e)}}const G={connection:function connection(e,t,r){const{host:n,port:s}=r||t,o=Object.assign(new Error("write "+e+" "+(t.path||n+":"+s)),{code:e,errno:e,address:t.path||n},t.path?{}:{port:s});return Error.captureStackTrace(o,connection),o},postgres:function postgres(e){const t=new PostgresError(e);return Error.captureStackTrace(t,postgres),t},generic:function generic(e,t){const r=Object.assign(new Error(e+": "+t),{code:e});return Error.captureStackTrace(r,generic),r},notSupported:function notSupported(e){const t=Object.assign(new Error(e+" (B) is not supported"),{code:"MESSAGE_NOT_SUPPORTED",name:e});return Error.captureStackTrace(t,notSupported),t}};const V={string:{to:25,from:null,serialize:e=>""+e},number:{to:0,from:[21,23,26,700,701],serialize:e=>""+e,parse:e=>+e},json:{to:114,from:[114,3802],serialize:e=>JSON.stringify(e),parse:e=>JSON.parse(e)},boolean:{to:16,from:16,serialize:e=>!0===e?"t":"f",parse:e=>"t"===e},date:{to:1184,from:[1082,1114,1184],serialize:e=>(e instanceof Date?e:new Date(e)).toISOString(),parse:e=>new Date(e)},bytea:{to:17,from:17,serialize:e=>"\\x"+t.from(e).toString("hex"),parse:e=>t.from(e.slice(2),"hex")}};class NotTagged{then(){notTagged()}catch(){notTagged()}finally(){notTagged()}}class Identifier extends NotTagged{constructor(e){super(),this.value=escapeIdentifier(e)}}class Parameter extends NotTagged{constructor(e,t,r){super(),this.value=e,this.type=t,this.array=r}}class Builder extends NotTagged{constructor(e,t){super(),this.first=e,this.rest=t}build(e,t,r,n){const s=F.map((([t,r])=>({fn:r,i:e.search(t)}))).sort(((e,t)=>e.i-t.i)).pop();return-1===s.i?escapeIdentifiers(this.first,n):s.fn(this.first,this.rest,t,r,n)}}function handleValue(e,t,r,n){let s=e instanceof Parameter?e.value:e;if(void 0===s&&(e instanceof Parameter?e.value=n.transform.undefined:s=e=n.transform.undefined,void 0===s))throw G.generic("UNDEFINED_VALUE","Undefined values are not allowed");return"$"+r.push(e instanceof Parameter?(t.push(e.value),e.array?e.array[e.type||Y(e.value)]||e.type||firstIsString(e.value):e.type):(t.push(e),Y(e)))}const q=typeHandlers(V);function stringify(e,t,r,n,s,o){for(let a=1;a<e.strings.length;a++)t+=stringifyValue(t,r,n,s,o)+e.strings[a],r=e.args[a];return t}function stringifyValue(e,t,r,n,s){return t instanceof Builder?t.build(e,r,n,s):t instanceof Query?fragment(t,r,n,s):t instanceof Identifier?t.value:t&&t[0]instanceof Query?t.reduce(((e,t)=>e+" "+fragment(t,r,n,s)),""):handleValue(t,r,n,s)}function fragment(e,t,r,n){return e.fragment=!0,stringify(e,e.strings[0],e.args[0],t,r,n)}function valuesBuilder(e,t,r,n,s){return e.map((e=>"("+n.map((n=>stringifyValue("values",e[n],t,r,s))).join(",")+")")).join(",")}function values(e,t,r,n,s){const o=Array.isArray(e[0]);return valuesBuilder(o?e:[e],r,n,t.length?t.flat():Object.keys(o?e[0]:e),s)}function select(e,t,r,n,s){if("string"==typeof e&&(e=[e].concat(t)),Array.isArray(e))return escapeIdentifiers(e,s);let o;return(t.length?t.flat():Object.keys(e)).map((t=>(o=e[t],(o instanceof Query?fragment(o,r,n,s):o instanceof Identifier?o.value:handleValue(o,r,n,s))+" as "+escapeIdentifier(s.transform.column.to?s.transform.column.to(t):t)))).join(",")}const F=Object.entries({values:values,in:(...e)=>{const t=values(...e);return"()"===t?"(null)":t},select:select,as:select,returning:select,"\\(":select,update:(e,t,r,n,s)=>(t.length?t.flat():Object.keys(e)).map((t=>escapeIdentifier(s.transform.column.to?s.transform.column.to(t):t)+"="+stringifyValue("values",e[t],r,n,s))),insert(e,t,r,n,s){const o=t.length?t.flat():Object.keys(Array.isArray(e)?e[0]:e);return"("+escapeIdentifiers(o,s)+")values"+valuesBuilder(Array.isArray(e)?e:[e],r,n,o,s)}}).map((([e,t])=>[new RegExp("((?:^|[\\s(])"+e+"(?:$|[\\s(]))(?![\\s\\S]*\\1)","i"),t]));function notTagged(){throw G.generic("NOT_TAGGED_CALL","Query not called as a tagged template literal")}const Q=q.serializers,K=q.parsers;function firstIsString(e){return Array.isArray(e)?firstIsString(e[0]):"string"==typeof e?1009:0}const mergeUserTypes=function(e){const t=typeHandlers(e||{});return{serializers:Object.assign({},Q,t.serializers),parsers:Object.assign({},K,t.parsers)}};function typeHandlers(e){return Object.keys(e).reduce(((t,r)=>(e[r].from&&[].concat(e[r].from).forEach((n=>t.parsers[n]=e[r].parse)),e[r].serialize&&(t.serializers[e[r].to]=e[r].serialize,e[r].from&&[].concat(e[r].from).forEach((n=>t.serializers[n]=e[r].serialize))),t)),{parsers:{},serializers:{}})}function escapeIdentifiers(e,{transform:{column:t}}){return e.map((e=>escapeIdentifier(t.to?t.to(e):e))).join(",")}const escapeIdentifier=function(e){return'"'+e.replace(/"/g,'""').replace(/\./g,'"."')+'"'},Y=function inferType(e){return e instanceof Parameter?e.type:e instanceof Date?1184:e instanceof Uint8Array?17:!0===e||!1===e?16:"bigint"==typeof e?20:Array.isArray(e)?inferType(e[0]):0},H=/\\/g,J=/"/g;const W=function arraySerializer(e,t,r,n){if(!1===Array.isArray(e))return e;if(!e.length)return"{}";const s=e[0],o=1020===n?";":",";return Array.isArray(s)&&!s.type?"{"+e.map((e=>arraySerializer(e,t,r,n))).join(o)+"}":"{"+e.map((e=>{if(void 0===e&&void 0===(e=r.transform.undefined))throw G.generic("UNDEFINED_VALUE","Undefined values are not allowed");return null===e?"null":'"'+function(e){return e.replace(H,"\\\\").replace(J,'\\"')}(t?t(e.type?e.value:e):""+e)+'"'})).join(o)+"}"},X={i:0,char:null,str:"",quoted:!1,last:0},arrayParser=function(e,t,r){return X.i=X.last=0,arrayParserLoop(X,e,t,r)};function arrayParserLoop(e,t,r,n){const s=[],o=1020===n?";":",";for(;e.i<t.length;e.i++){if(e.char=t[e.i],e.quoted)"\\"===e.char?e.str+=t[++e.i]:'"'===e.char?(s.push(r?r(e.str):e.str),e.str="",e.quoted='"'===t[e.i+1],e.last=e.i+2):e.str+=e.char;else if('"'===e.char)e.quoted=!0;else if("{"===e.char)e.last=++e.i,s.push(arrayParserLoop(e,t,r,n));else{if("}"===e.char){e.quoted=!1,e.last<e.i&&s.push(r?r(t.slice(e.last,e.i)):t.slice(e.last,e.i)),e.last=e.i+1;break}e.char===o&&"}"!==e.p&&'"'!==e.p&&(s.push(r?r(t.slice(e.last,e.i)):t.slice(e.last,e.i)),e.last=e.i+1)}e.p=e.char}return e.last<e.i&&s.push(r?r(t.slice(e.last,e.i+1)):t.slice(e.last,e.i+1)),s}const toCamel=e=>{let t=e[0];for(let r=1;r<e.length;r++)t+="_"===e[r]?e[++r].toUpperCase():e[r];return t},toPascal=e=>{let t=e[0].toUpperCase();for(let r=1;r<e.length;r++)t+="_"===e[r]?e[++r].toUpperCase():e[r];return t},toKebab=e=>e.replace(/_/g,"-"),fromCamel=e=>e.replace(/([A-Z])/g,"_$1").toLowerCase(),fromPascal=e=>(e.slice(0,1)+e.slice(1).replace(/([A-Z])/g,"_$1")).toLowerCase(),fromKebab=e=>e.replace(/-/g,"_");function createJsonTransform(e){return function jsonTransform(t,r){return"object"!=typeof t||null===t||114!==r.type&&3802!==r.type?t:Array.isArray(t)?t.map((e=>jsonTransform(e,r))):Object.entries(t).reduce(((t,[n,s])=>Object.assign(t,{[e(n)]:jsonTransform(s,r)})),{})}}toCamel.column={from:toCamel},toCamel.value={from:createJsonTransform(toCamel)},fromCamel.column={to:fromCamel};const Z={...toCamel};Z.column.to=fromCamel,toPascal.column={from:toPascal},toPascal.value={from:createJsonTransform(toPascal)},fromPascal.column={to:fromPascal};const ee={...toPascal};ee.column.to=fromPascal,toKebab.column={from:toKebab},toKebab.value={from:createJsonTransform(toKebab)},fromKebab.column={to:fromKebab};const te={...toKebab};te.column.to=fromKebab;class Result extends Array{constructor(){super(),Object.defineProperties(this,{count:{value:null,writable:!0},state:{value:null,writable:!0},command:{value:null,writable:!0},columns:{value:null,writable:!0},statement:{value:null,writable:!0}})}static get[Symbol.species](){return Array}}function Queue(e=[]){let t=e.slice(),r=0;return{get length(){return t.length-r},remove:e=>{const r=t.indexOf(e);return-1===r?null:(t.splice(r,1),e)},push:e=>(t.push(e),e),shift:()=>{const e=t[r++];return r===t.length?(r=0,t=[]):t[r-1]=void 0,e}}}let re=t.allocUnsafe(256);const ne="BCcDdEFfHPpQSX".split("").reduce(((e,t)=>{const r=t.charCodeAt(0);return e[t]=()=>(re[0]=r,se.i=5,se),e}),{}),se=Object.assign((function(){return se.i=0,se}),ne,{N:String.fromCharCode(0),i:0,inc:e=>(se.i+=e,se),str(e){const r=t.byteLength(e);return fit(r),se.i+=re.write(e,se.i,r,"utf8"),se},i16:e=>(fit(2),re.writeUInt16BE(e,se.i),se.i+=2,se),i32:(e,t)=>t||0===t?(re.writeUInt32BE(e,t),se):(fit(4),re.writeUInt32BE(e,se.i),se.i+=4,se),z:e=>(fit(e),re.fill(0,se.i,se.i+e),se.i+=e,se),raw:e=>(re=t.concat([re.subarray(0,se.i),e]),se.i=re.length,se),end(e=1){re.writeUInt32BE(se.i-e,e);const r=re.subarray(0,se.i);return se.i=0,re=t.allocUnsafe(256),r}});function fit(e){if(re.length-se.i<e){const r=re,n=r.length;re=t.allocUnsafe(n+(n>>1)+e),r.copy(re)}}let oe=1;const ae=se().S().end(),ie=se().H().end(),ce=se().i32(8).i32(80877103).end(8),le=t.concat([se().E().str(se.N).i32(0).end(),ae]),ue=se().D().str("S").str(se.N).end(),noop$1=()=>{},fe=new Set(["FetchPreparedStatement","RevalidateCachedQuery","transformAssignedExpr"]),de={83:"severity_local",86:"severity",67:"code",77:"message",68:"detail",72:"hint",80:"position",112:"internal_position",113:"internal_query",87:"where",115:"schema_name",116:"table_name",99:"column_name",100:"data type_name",110:"constraint_name",70:"file",76:"line",82:"routine"};function Connection(e,n={},{onopen:s=noop$1,onend:o=noop$1,onclose:a=noop$1}={}){const{ssl:i,max:c,user:l,host:u,port:f,database:d,parsers:p,transform:m,onnotice:h,onnotify:g,onparameter:y,max_pipeline:E,keep_alive:w,backoff:b,target_session_attrs:v}=e,S=Queue(),_=oe++,P={pid:null,secret:null},N=timer(end,e.idle_timeout),T=timer(end,e.max_lifetime),A=timer((function(){errored(G.connection("CONNECT_TIMEOUT",e,D)),D.destroy()}),e.connect_timeout);let R,D=null,x=new Result,L=t.alloc(0),U=e.fetch_types,B={},z={},M=Math.random().toString(36).slice(2),V=1,q=0,F=0,Q=0,K=0,Y=0,H=0,J=0,X=null,Z=null,ee=!1,te=null,re=null,ne=null,de=null,pe=null,me=null,he=null,ge=null,ye=null,Ee=null;const we={queue:n.closed,idleTimer:N,connect(e){ne=e||!0,reconnect()},terminate:terminate,execute:execute,cancel:async function({pid:e,secret:t},r,n){try{R=se().i32(16).i32(80877102).i32(e).i32(t).end(16),await connect(),D.once("error",n),D.once("close",r)}catch(e){n(e)}},end:end,count:0,id:_};return n.closed&&n.closed.push(we),we;function execute(r){if(ee)return queryError(r,G.connection("CONNECTION_DESTROYED",e));if(!r.cancelled)try{return r.state=P,ye?S.push(r):(ye=r,ye.active=!0),function(t){const r=[],n=[],s=stringify(t,t.strings[0],t.args[0],r,n,e);!t.tagged&&t.args.forEach((t=>handleValue(t,r,n,e))),t.prepare=e.prepare&&(!("prepare"in t.options)||t.options.prepare),t.string=s,t.signature=t.prepare&&n+s,t.onlyDescribe&&delete z[t.signature],t.parameters=t.parameters||r,t.prepared=t.prepare&&t.signature in z,t.describeFirst=t.onlyDescribe||r.length&&!t.prepared,t.statement=t.prepared?z[t.signature]:{string:s,types:n,name:t.prepare?M+V++:""},"function"==typeof e.debug&&e.debug(_,s,r,n)}(r),write(function(e){if(e.parameters.length>=65534)throw G.generic("MAX_PARAMETERS_EXCEEDED","Max number of parameters (65534) exceeded");return e.options.simple?se().Q().str(e.statement.string+se.N).end():e.describeFirst?t.concat([describe(e),ie]):e.prepare?e.prepared?prepared(e):t.concat([describe(e),prepared(e)]):function(e){return t.concat([Parse(e.statement.string,e.parameters,e.statement.types),ue,prepared(e)])}(e)}(r))&&!r.describeFirst&&!r.cursorFn&&S.length<E&&(!r.options.onexecute||r.options.onexecute(we))}catch(e){return 0===S.length&&write(ae),errored(e),!0}}function describe(e){return t.concat([Parse(e.statement.string,e.parameters,e.statement.types,e.statement.name),Describe("S",e.statement.name)])}function prepared(e){return t.concat([Bind(e.parameters,e.statement.types,e.statement.name,e.cursorName),e.cursorFn?Execute("",e.cursorRows):le])}function write(e,r){return me=me?t.concat([me,e]):t.from(e),me.length>=1024?nextWrite(r):(null===Z&&(Z=function(e){const t=O++;return I.add(t),queueMicrotask((()=>{I.has(t)&&(e(),I.delete(t))})),t}(nextWrite)),!0)}function nextWrite(e){const t=D.write(me,e);return null!==Z&&clearImmediate(Z),me=Z=null,t}async function secure(){write(ce);if(!await new Promise((e=>D.once("data",(t=>e(83===t[0])))))&&"prefer"===i)return connected();D.removeAllListeners(),D=$.connect({socket:D,servername:k.isIP(D.host)?void 0:D.host,..."require"===i||"allow"===i||"prefer"===i?{rejectUnauthorized:!1}:"verify-full"===i?{}:"object"==typeof i?i:{}}),D.on("secureConnect",connected),D.on("error",error),D.on("close",closed),D.on("drain",drain)}function drain(){!ye&&s(we)}function data(e){if(!(te&&(te.push(e),F-=e.length,F>=0)))for(L=te?t.concat(te,Y-F):0===L.length?e:t.concat([L,e],L.length+e.length);L.length>4;){if(Y=L.readUInt32BE(1),Y>=L.length){F=Y-L.length,te=[L];break}try{handle(L.subarray(0,Y+1))}catch(e){ye&&(ye.cursorFn||ye.describeFirst)&&write(ae),errored(e)}L=L.subarray(Y+1),F=0,te=null}}async function connect(){if(ee=!1,B={},D||(D=await async function(){let t;try{t=e.socket?await Promise.resolve(e.socket(e)):new k.Socket}catch(e){return void error(e)}return t.on("error",error),t.on("close",closed),t.on("drain",drain),t}()),D){if(A.start(),e.socket)return i?secure():connected();if(D.on("connect",i?secure:connected),e.path)return D.connect(e.path);D.ssl=i,D.connect(f[Q],u[Q]),D.host=u[Q],D.port=f[Q],Q=(Q+1)%f.length}}function reconnect(){setTimeout(connect,q?q+H-C.now():0)}function connected(){try{z={},U=e.fetch_types,M=Math.random().toString(36).slice(2),V=1,T.start(),D.on("data",data),w&&D.setKeepAlive&&D.setKeepAlive(!0,1e3*w);write(R||se().inc(4).i16(3).z(2).str(Object.entries(Object.assign({user:l,database:d,client_encoding:"UTF8"},e.connection)).filter((([,e])=>e)).map((([e,t])=>e+se.N+t)).join(se.N)).z(2).end(0))}catch(e){error(e)}}function error(t){if(we.queue!==n.connecting||!e.host[K+1])for(errored(t);S.length;)queryError(S.shift(),t)}function errored(e){pe&&(pe.destroy(e),pe=null),ye&&queryError(ye,e),ne&&(queryError(ne,e),ne=null)}function queryError(t,r){"query"in r||"parameters"in r||Object.defineProperties(r,{stack:{value:r.stack+t.origin.replace(/.*\n/,"\n"),enumerable:e.debug},query:{value:t.string,enumerable:e.debug},parameters:{value:t.parameters,enumerable:e.debug},args:{value:t.args,enumerable:e.debug},types:{value:t.statement&&t.statement.types,enumerable:e.debug}}),t.reject(r)}function end(){return de||(!we.reserved&&o(we),we.reserved||ne||ye||0!==S.length?de=new Promise((e=>he=e)):(terminate(),new Promise((e=>D&&"closed"!==D.readyState?D.once("close",e):e()))))}function terminate(){ee=!0,(pe||ye||ne||S.length)&&error(G.connection("CONNECTION_DESTROYED",e)),clearImmediate(Z),D&&(D.removeListener("data",data),D.removeListener("connect",connected),"open"===D.readyState&&D.end(se().X().end())),he&&(he(),de=he=null)}async function closed(r){if(L=t.alloc(0),F=0,te=null,clearImmediate(Z),D.removeListener("data",data),D.removeListener("connect",connected),N.cancel(),T.cancel(),A.cancel(),D.removeAllListeners(),D=null,ne)return reconnect();!r&&(ye||S.length)&&error(G.connection("CONNECTION_CLOSED",e,D)),q=C.now(),r&&e.shared.retries++,H=1e3*("function"==typeof b?b(e.shared.retries):b),a(we,G.connection("CONNECTION_CLOSED",e,D))}function handle(e,t=e[0]){(68===t?DataRow:100===t?CopyData:65===t?NotificationResponse:83===t?ParameterStatus:90===t?ReadyForQuery:67===t?CommandComplete:50===t?BindComplete:49===t?ParseComplete:116===t?ParameterDescription:84===t?RowDescription:82===t?Authentication:110===t?NoData:75===t?BackendKeyData:69===t?ErrorResponse:115===t?PortalSuspended:51===t?CloseComplete:71===t?CopyInResponse:78===t?NoticeResponse:72===t?CopyOutResponse:99===t?CopyDone:73===t?EmptyQueryResponse:86===t?FunctionCallResponse:118===t?NegotiateProtocolVersion:87===t?CopyBothResponse:UnknownMessage)(e)}function DataRow(e){let t,r,n,s=7;const o=ye.isRaw?new Array(ye.statement.columns.length):{};for(let a=0;a<ye.statement.columns.length;a++)r=ye.statement.columns[a],t=e.readInt32BE(s),s+=4,n=-1===t?null:!0===ye.isRaw?e.subarray(s,s+=t):void 0===r.parser?e.toString("utf8",s,s+=t):!0===r.parser.array?r.parser(e.toString("utf8",s+1,s+=t)):r.parser(e.toString("utf8",s,s+=t)),ye.isRaw?o[a]=!0===ye.isRaw?n:m.value.from?m.value.from(n,r):n:o[r.name]=m.value.from?m.value.from(n,r):n;ye.forEachFn?ye.forEachFn(m.row.from?m.row.from(o):o,x):x[J++]=m.row.from?m.row.from(o):o}function ParameterStatus(t){const[r,n]=t.toString("utf8",5,t.length-1).split(se.N);B[r]=n,e.parameters[r]!==n&&(e.parameters[r]=n,y&&y(r,n))}function ReadyForQuery(t){if(ye&&ye.options.simple&&ye.resolve(re||x),ye=re=null,x=new Result,A.cancel(),ne){if(v){if(!B.in_hot_standby||!B.default_transaction_read_only)return function(){const e=new Query(["\n      show transaction_read_only;\n      select pg_catalog.pg_is_in_recovery()\n    "],[],execute,null,{simple:!0});e.resolve=([[e],[t]])=>{B.default_transaction_read_only=e.transaction_read_only,B.in_hot_standby=t.pg_is_in_recovery?"on":"off"},e.execute()}();if(function(t,r){return"read-write"===t&&"on"===r.default_transaction_read_only||"read-only"===t&&"off"===r.default_transaction_read_only||"primary"===t&&"on"===r.in_hot_standby||"standby"===t&&"off"===r.in_hot_standby||"prefer-standby"===t&&"off"===r.in_hot_standby&&e.host[K]}(v,B))return terminate()}return U?(!0===ne&&(ne=null),async function(){U=!1;const t=await new Query(["\n      select b.oid, b.typarray\n      from pg_catalog.pg_type a\n      left join pg_catalog.pg_type b on b.oid = a.typelem\n      where a.typcategory = 'A'\n      group by b.oid, b.typarray\n      order by b.oid\n    "],[],execute);t.forEach((({oid:t,typarray:r})=>function(t,r){if(e.parsers[r]&&e.serializers[r])return;const n=e.parsers[t];e.shared.typeArrayMap[t]=r,e.parsers[r]=e=>arrayParser(e,n,r),e.parsers[r].array=!0,e.serializers[r]=n=>W(n,e.serializers[t],e,r)}(t,r)))}()):(!0!==ne&&execute(ne),e.shared.retries=K=0,void(ne=null))}for(;S.length&&(ye=S.shift())&&(ye.active=!0,ye.cancelled);)Connection(e).cancel(ye.state,ye.cancelled.resolve,ye.cancelled.reject);ye||(we.reserved?we.reserved.release||73!==t[5]?we.reserved():de?terminate():(we.reserved=null,s(we)):de?terminate():s(we))}function CommandComplete(e){J=0;for(let t=e.length-1;t>0;t--)if(32===e[t]&&e[t+1]<58&&null===x.count&&(x.count=+e.toString("utf8",t+1,e.length-1)),e[t-1]>=65){x.command=e.toString("utf8",5,t),x.state=P;break}return Ee&&(Ee(),Ee=null),"BEGIN"!==x.command||1===c||we.reserved?ye.options.simple?BindComplete():(ye.cursorFn&&(x.count&&ye.cursorFn(x),write(ae)),void ye.resolve(x)):errored(G.generic("UNSAFE_TRANSACTION","Only use sql.begin, sql.reserved or max: 1"))}function ParseComplete(){ye.parsing=!1}function BindComplete(){!x.statement&&(x.statement=ye.statement),x.columns=ye.statement.columns}function ParameterDescription(e){const t=e.readUInt16BE(5);for(let r=0;r<t;++r)!ye.statement.types[r]&&(ye.statement.types[r]=e.readUInt32BE(7+4*r));ye.prepare&&(z[ye.signature]=ye.statement),ye.describeFirst&&!ye.onlyDescribe&&(write(prepared(ye)),ye.describeFirst=!1)}function RowDescription(e){x.command&&(re=re||[x],re.push(x=new Result),x.count=null,ye.statement.columns=null);const t=e.readUInt16BE(5);let r,n=7;ye.statement.columns=Array(t);for(let s=0;s<t;++s){for(r=n;0!==e[n++];);const t=e.readUInt32BE(n),o=e.readUInt16BE(n+4),a=e.readUInt32BE(n+6);ye.statement.columns[s]={name:m.column.from?m.column.from(e.toString("utf8",r,n-1)):e.toString("utf8",r,n-1),parser:p[a],table:t,number:o,type:a},n+=18}if(x.statement=ye.statement,ye.onlyDescribe)return ye.resolve(ye.statement),write(ae)}async function Authentication(e,t=e.readUInt32BE(5)){(3===t?AuthenticationCleartextPassword:5===t?AuthenticationMD5Password:10===t?SASL:11===t?SASLContinue:12===t?SASLFinal:0!==t?UnknownAuth:noop$1)(e,t)}async function AuthenticationCleartextPassword(){const e=await Pass();write(se().p().str(e).z(1).end())}async function AuthenticationMD5Password(e){const r="md5"+await md5(t.concat([t.from(await md5(await Pass()+l)),e.subarray(9)]));write(se().p().str(r).z(1).end())}async function SASL(){ge=(await crypto$1_randomBytes(18)).toString("base64"),se().p().str("SCRAM-SHA-256"+se.N);const e=se.i;write(se.inc(4).str("n,,n=*,r="+ge).i32(se.i-e-4,e).end())}async function SASLContinue(e){const r=e.toString("utf8",9).split(",").reduce(((e,t)=>(e[t[0]]=t.slice(2),e)),{}),n=await crypto$1_pbkdf2Sync(await Pass(),t.from(r.s,"base64"),parseInt(r.i),32,"sha256"),s=await hmac(n,"Client Key"),o="n=*,r="+ge+",r="+r.r+",s="+r.s+",i="+r.i+",c=biws,r="+r.r;X=(await hmac(await hmac(n,"Server Key"),o)).toString("base64");const a="c=biws,r="+r.r+",p="+function(e,r){const n=Math.max(e.length,r.length),s=t.allocUnsafe(n);for(let t=0;t<n;t++)s[t]=e[t]^r[t];return s}(s,t.from(await hmac(await function(e){return crypto$1_createHash("sha256").update(e).digest()}(s),o))).toString("base64");write(se().p().str(a).end())}function SASLFinal(e){e.toString("utf8",9).split(se.N,1)[0].slice(2)!==X&&(errored(G.generic("SASL_SIGNATURE_MISMATCH","The server did not return the correct signature")),D.destroy())}function Pass(){return Promise.resolve("function"==typeof e.pass?e.pass():e.pass)}function NoData(){if(x.statement=ye.statement,x.statement.columns=[],ye.onlyDescribe)return ye.resolve(ye.statement),write(ae)}function BackendKeyData(e){P.pid=e.readUInt32BE(5),P.secret=e.readUInt32BE(9)}function ErrorResponse(e){ye&&(ye.cursorFn||ye.describeFirst)&&write(ae);const t=G.postgres(parseError(e));ye&&ye.retried?errored(ye.retried):ye&&ye.prepared&&fe.has(t.routine)?function(e,t){delete z[e.signature],e.retried=t,execute(e)}(ye,t):errored(t)}function NotificationResponse(e){if(!g)return;let t=9;for(;0!==e[t++];);g(e.toString("utf8",9,t-1),e.toString("utf8",t,e.length-1))}async function PortalSuspended(){try{const e=await Promise.resolve(ye.cursorFn(x));J=0,e===j?write(function(e=""){return t.concat([se().C().str("P").str(e+se.N).end(),se().S().end()])}(ye.portal)):(x=new Result,write(Execute("",ye.cursorRows)))}catch(e){write(ae),ye.reject(e)}}function CloseComplete(){x.count&&ye.cursorFn(x),ye.resolve(x)}function CopyInResponse(){pe=new r.Writable({autoDestroy:!0,write(e,t,r){D.write(se().d().raw(e).end(),r)},destroy(e,t){t(e),D.write(se().f().str(e+se.N).end()),pe=null},final(e){D.write(se().c().end()),Ee=e}}),ye.resolve(pe)}function CopyOutResponse(){pe=new r.Readable({read(){D.resume()}}),ye.resolve(pe)}function CopyBothResponse(){pe=new r.Duplex({autoDestroy:!0,read(){D.resume()},write(e,t,r){D.write(se().d().raw(e).end(),r)},destroy(e,t){t(e),D.write(se().f().str(e+se.N).end()),pe=null},final(e){D.write(se().c().end()),Ee=e}}),ye.resolve(pe)}function CopyData(e){pe&&(pe.push(e.subarray(5))||D.pause())}function CopyDone(){pe&&pe.push(null),pe=null}function NoticeResponse(e){h?h(parseError(e)):console.log(parseError(e))}function EmptyQueryResponse(){}function FunctionCallResponse(){errored(G.notSupported("FunctionCallResponse"))}function NegotiateProtocolVersion(){errored(G.notSupported("NegotiateProtocolVersion"))}function UnknownMessage(e){console.error("Postgres.js : Unknown Message:",e[0])}function UnknownAuth(e,t){console.error("Postgres.js : Unknown Auth:",t)}function Bind(t,r,n="",s=""){let o,a;return se().B().str(s+se.N).str(n+se.N).i16(0).i16(t.length),t.forEach(((n,s)=>{if(null===n)return se.i32(4294967295);a=r[s],t[s]=n=a in e.serializers?e.serializers[a](n):""+n,o=se.i,se.inc(4).str(n).i32(se.i-o-4,o)})),se.i16(0),se.end()}function Parse(e,t,r,n=""){return se().P().str(n+se.N).str(e+se.N).i16(t.length),t.forEach(((e,t)=>se.i32(r[t]||0))),se.end()}function Describe(e,t=""){return se().D().str(e).str(t+se.N).end()}function Execute(e="",r=0){return t.concat([se().E().str(e+se.N).i32(r).end(),ie])}}function parseError(e){const t={};let r=5;for(let n=5;n<e.length-1;n++)0===e[n]&&(t[de[e[r]]]=e.toString("utf8",r+1,n),r=n+1);return t}function md5(e){return crypto$1_createHash("md5").update(e).digest("hex")}function hmac(e,t){return crypto$1_createHmac("sha256",e).update(t).digest()}function timer(e,t){if(!(t="function"==typeof t?t():t))return{cancel:noop$1,start:noop$1};let r;return{cancel(){r&&(clearTimeout(r),r=null)},start(){r&&clearTimeout(r),r=setTimeout(done,1e3*t,arguments)}};function done(t){e.apply(null,t),r=null}}const noop=()=>{};function Subscribe(e,r){const n=new Map,s="postgresjs_"+Math.random().toString(36).slice(2),o={};let a,i,c=!1;const l=subscribe.sql=e({...r,transform:{column:{},value:{},row:{}},max:1,fetch_types:!1,idle_timeout:null,max_lifetime:null,connection:{...r.connection,replication:"database"},onclose:async function(){c||(i=null,o.pid=o.secret=void 0,connected(await init(l,s,r.publications)),n.forEach((e=>e.forEach((({onsubscribe:e})=>e())))))},no_subscribe:!0}),u=l.end,f=l.close;return l.end=async()=>(c=!0,i&&await new Promise((e=>(i.once("close",e),i.end()))),u()),l.close=async()=>(i&&await new Promise((e=>(i.once("close",e),i.end()))),f()),subscribe;async function subscribe(e,t,c=noop,u=noop){e=function(e){const t=e.match(/^(\*|insert|update|delete)?:?([^.]+?\.?[^=]+)?=?(.+)?/i)||[];if(!t)throw new Error("Malformed subscribe pattern: "+e);const[,r,n,s]=t;return(r||"*")+(n?":"+(-1===n.indexOf(".")?"public."+n:n):"")+(s?"="+s:"")}(e),a||(a=init(l,s,r.publications));const f={fn:t,onsubscribe:c},d=n.has(e)?n.get(e).add(f):n.set(e,new Set([f])).get(e),unsubscribe=()=>{d.delete(f),0===d.size&&n.delete(e)};return a.then((e=>(connected(e),c(),i&&i.on("error",u),{unsubscribe:unsubscribe,state:o,sql:l})))}function connected(e){i=e.stream,o.pid=e.state.pid,o.secret=e.state.secret}async function init(e,n,s){if(!s)throw new Error("Missing publication names");const o=await e.unsafe(`CREATE_REPLICATION_SLOT ${n} TEMPORARY LOGICAL pgoutput NOEXPORT_SNAPSHOT`),[a]=o,i=await e.unsafe(`START_REPLICATION SLOT ${n} LOGICAL ${a.consistent_point} (proto_version '1', publication_names '${s}')`).writable(),c={lsn:t.concat(a.consistent_point.split("/").map((e=>t.from(("00000000"+e).slice(-8),"hex"))))};return i.on("data",(function(n){119===n[0]?function(e,t,r,n,s){const char=(e,[t,r])=>(e[t.charCodeAt(0)]=r,e);Object.entries({R:e=>{let n=1;const o=t[e.readUInt32BE(n)]={schema:e.toString("utf8",n+=4,n=e.indexOf(0,n))||"pg_catalog",table:e.toString("utf8",n+1,n=e.indexOf(0,n+1)),columns:Array(e.readUInt16BE(n+=2)),keys:[]};n+=2;let a,i=0;for(;n<e.length;)a=o.columns[i++]={key:e[n++],name:s.column.from?s.column.from(e.toString("utf8",n,n=e.indexOf(0,n))):e.toString("utf8",n,n=e.indexOf(0,n)),type:e.readUInt32BE(n+=1),parser:r[e.readUInt32BE(n)],atttypmod:e.readUInt32BE(n+=4)},a.key&&o.keys.push(a),n+=4},Y:()=>{},O:()=>{},B:e=>{t.date=function(e){return new Date(Date.UTC(2e3,0,1)+Number(e/BigInt(1e3)))}(e.readBigInt64BE(9)),t.lsn=e.subarray(1,9)},I:e=>{let r=1;const o=t[e.readUInt32BE(r)],{row:a}=tuples(e,o.columns,r+=7,s);n(a,{command:"insert",relation:o})},D:e=>{let r=1;const o=t[e.readUInt32BE(r)];r+=4;const a=75===e[r];n(a||79===e[r]?tuples(e,o.columns,r+=3,s).row:null,{command:"delete",relation:o,key:a})},U:e=>{let r=1;const o=t[e.readUInt32BE(r)];r+=4;const a=75===e[r],i=a||79===e[r]?tuples(e,o.columns,r+=3,s):null;i&&(r=i.i);const{row:c}=tuples(e,o.columns,r+3,s);n(c,{command:"update",relation:o,key:a,old:i&&i.row})},T:()=>{},C:()=>{}}).reduce(char,{})[e[0]](e)}(n.subarray(25),c,e.options.parsers,handle,r.transform):107===n[0]&&n[17]&&(c.lsn=n.subarray(1,9),function(){const e=t.alloc(34);e[0]="r".charCodeAt(0),e.fill(c.lsn,1),e.writeBigInt64BE(BigInt(Date.now()-Date.UTC(2e3,0,1))*BigInt(1e3),25),i.write(e)}())})),i.on("error",(function(e){console.error("Unexpected error during logical streaming - reconnecting",e)})),i.on("close",e.close),{stream:i,state:o.state};function handle(e,t){const r=t.relation.schema+"."+t.relation.table;call("*",e,t),call("*:"+r,e,t),t.relation.keys.length&&call("*:"+r+"="+t.relation.keys.map((t=>e[t.name])),e,t),call(t.command,e,t),call(t.command+":"+r,e,t),t.relation.keys.length&&call(t.command+":"+r+"="+t.relation.keys.map((t=>e[t.name])),e,t)}}function call(e,t,r){n.has(e)&&n.get(e).forEach((({fn:n})=>n(t,r,e)))}}function tuples(e,t,r,n){let s,o,a;const i=n.raw?new Array(t.length):{};for(let c=0;c<t.length;c++)s=e[r++],o=t[c],a=110===s?null:117===s?void 0:void 0===o.parser?e.toString("utf8",r+4,r+=4+e.readUInt32BE(r)):!0===o.parser.array?o.parser(e.toString("utf8",r+5,r+=4+e.readUInt32BE(r))):o.parser(e.toString("utf8",r+4,r+=4+e.readUInt32BE(r))),n.raw?i[c]=!0===n.raw?a:n.value.from?n.value.from(a,o):a:i[o.name]=n.value.from?n.value.from(a,o):a;return{i:r,row:n.row.from?n.row.from(i):i}}function largeObject(e,t,n=393216){return new Promise((async(s,o)=>{await e.begin((async e=>{let o;!t&&([{oid:t}]=await(e`select lo_creat(-1) as oid`));const[{fd:a}]=await(e`select lo_open(${t}, ${n}) as fd`),i={writable:async function({highWaterMark:e=16384,start:t=0}={}){return t&&await i.seek(t),new r.Writable({highWaterMark:e,write(e,t,r){i.write(e).then((()=>r()),r)}})},readable:async function({highWaterMark:e=16384,start:t=0,end:n=1/0}={}){let s=n-t;return t&&await i.seek(t),new r.Readable({highWaterMark:e,async read(e){const t=e>s?e-s:e;s-=e;const[{data:r}]=await i.read(t);this.push(r),r.length<e&&this.push(null)}})},close:()=>e`select lo_close(${a})`.then(o),tell:()=>e`select lo_tell64(${a})`,read:t=>e`select loread(${a}, ${t}) as data`,write:t=>e`select lowrite(${a}, ${t})`,truncate:t=>e`select lo_truncate64(${a}, ${t})`,seek:(t,r=0)=>e`select lo_lseek64(${a}, ${t}, ${r})`,size:()=>e`
          select
            lo_lseek64(${a}, location, 0) as position,
            seek.size
          from (
            select
              lo_lseek64($1, 0, 2) as size,
              tell.location
            from (select lo_tell64($1) as location) tell
          ) seek
        `};return s(i),new Promise((async e=>o=e))})).catch(o)}))}function Postgres(e,t){const r=function(e,t){if(e&&e.shared)return e;const r=x.env,n=(e&&"string"!=typeof e?e:t)||{},{url:s,multihost:o}=function(e){if(!e||"string"!=typeof e)return{url:{searchParams:new Map}};let t=e;t=t.slice(t.indexOf("://")+3).split(/[?/]/)[0],t=decodeURIComponent(t.slice(t.indexOf("@")+1));const r=new URL(e.replace(t,t.split(",")[0]));return{url:{username:decodeURIComponent(r.username),password:decodeURIComponent(r.password),host:r.host,hostname:r.hostname,port:r.port,pathname:r.pathname,searchParams:r.searchParams},multihost:t.indexOf(",")>-1&&t}}(e),a=[...s.searchParams].reduce(((e,[t,r])=>(e[t]=r,e)),{}),i=n.hostname||n.host||o||s.hostname||r.PGHOST||"localhost",c=n.port||s.port||r.PGPORT||5432,l=n.user||n.username||s.username||r.PGUSERNAME||r.PGUSER||function(){try{return L.userInfo().username}catch(e){return x.env.USERNAME||x.env.USER||x.env.LOGNAME}}();n.no_prepare&&(n.prepare=!1),a.sslmode&&(a.ssl=a.sslmode,delete a.sslmode),"timeout"in n&&(console.log("The timeout option is deprecated, use idle_timeout instead"),n.idle_timeout=n.timeout),"system"===a.sslrootcert&&(a.ssl="verify-full");const u=["idle_timeout","connect_timeout","max_lifetime","max_pipeline","backoff","keep_alive"],f={max:10,ssl:!1,idle_timeout:null,connect_timeout:30,max_lifetime:max_lifetime,max_pipeline:100,backoff:backoff,keep_alive:60,prepare:!0,debug:!1,fetch_types:!0,publications:"alltables",target_session_attrs:null};return{host:Array.isArray(i)?i:i.split(",").map((e=>e.split(":")[0])),port:Array.isArray(c)?c:i.split(",").map((e=>parseInt(e.split(":")[1]||c))),path:n.path||i.indexOf("/")>-1&&i+"/.s.PGSQL."+c,database:n.database||n.db||(s.pathname||"").slice(1)||r.PGDATABASE||l,user:l,pass:n.pass||n.password||s.password||r.PGPASSWORD||"",...Object.entries(f).reduce(((e,[t,s])=>{const o=t in n?n[t]:t in a?"disable"!==a[t]&&"false"!==a[t]&&a[t]:r["PG"+t.toUpperCase()]||s;return e[t]="string"==typeof o&&u.includes(t)?+o:o,e}),{}),connection:{application_name:"postgres.js",...n.connection,...Object.entries(a).reduce(((e,[t,r])=>(t in f||(e[t]=r),e)),{})},types:n.types||{},target_session_attrs:tsa(n,s,r),onnotice:n.onnotice,onnotify:n.onnotify,onclose:n.onclose,onparameter:n.onparameter,socket:n.socket,transform:parseTransform(n.transform||{undefined:void 0}),parameters:{},shared:{retries:0,typeArrayMap:{}},...mergeUserTypes(n.types)}}(e,t),n=r.no_subscribe||Subscribe(Postgres,{...r});let s=!1;const o=Queue(),a=Queue(),i=Queue(),c=Queue(),l=Queue(),u=Queue(),f=Queue(),d=Queue(),p={connecting:a,closed:c},m=[...Array(r.max)].map((()=>Connection(r,p,{onopen:onopen,onend:onend,onclose:onclose}))),h=Sql((function(e){if(s)return e.reject(G.connection("CONNECTION_ENDED",r,r));if(u.length)return go(u.shift(),e);if(c.length)return connect(c.shift(),e);f.length?go(f.shift(),e):o.push(e)}));return Object.assign(h,{get parameters(){return r.parameters},largeObject:largeObject.bind(null,h),subscribe:n,CLOSE:j,END:j,PostgresError:PostgresError,options:r,reserve:async function(){const e=Queue(),t=u.length?u.shift():await new Promise((e=>{o.push({reserve:e}),c.length&&connect(c.shift())}));move(t,i),t.reserved=()=>e.length?t.execute(e.shift()):move(t,i),t.reserved.release=!0;const r=Sql((function(r){t.queue===d?e.push(r):t.execute(r)||move(t,d)}));return r.release=()=>{t.reserved=null,onopen(t)},r},listen:listen,begin:async function(e,t){!t&&(t=e,e="");const r=Queue();let n,s=0,o=null;try{return await h.unsafe("begin "+e.replace(/[^a-z ]/gi,""),[],{onexecute:function(e){n=e,move(e,i),e.reserved=()=>r.length?e.execute(r.shift()):move(e,i)}}).execute(),await Promise.race([async function scope(e,t,n){const a=Sql(handler);let i,c;a.savepoint=savepoint,a.prepare=e=>o=e.replace(/[^a-z0-9$-_. ]/gi),n&&await(a`savepoint ${a(n)}`);try{if(c=await new Promise(((e,r)=>{const n=t(a);Promise.resolve(Array.isArray(n)?Promise.all(n):n).then(e,r)})),i)throw i}catch(e){throw await(n?a`rollback to ${a(n)}`:a`rollback`),e instanceof PostgresError&&"25P02"===e.code&&i||e}n||(o?await(a`prepare transaction '${a.unsafe(o)}'`):await(a`commit`));return c;function savepoint(t,r){return t&&Array.isArray(t.raw)?savepoint((e=>e.apply(e,arguments))):(1===arguments.length&&(r=t,t=null),scope(e,r,"s"+s+++(t?"_"+t:"")))}function handler(t){t.catch((e=>i||(i=e))),e.queue===d?r.push(t):e.execute(t)||move(e,d)}}(n,t),new Promise(((e,t)=>n.onclose=t))])}catch(e){throw e}},close:async function(){await Promise.all(m.map((e=>e.end())))},end:async function({timeout:e=null}={}){if(s)return s;let t;return await 1,s=Promise.race([new Promise((r=>null!==e&&(t=setTimeout(destroy,1e3*e,r)))),Promise.all(m.map((e=>e.end())).concat(listen.sql?listen.sql.end({timeout:0}):[],n.sql?n.sql.end({timeout:0}):[]))]).then((()=>clearTimeout(t)))}}),h;function Sql(e){return e.debug=r.debug,Object.entries(r.types).reduce(((e,[t,r])=>(e[t]=e=>new Parameter(e,r.to),e)),typed),Object.assign(sql,{types:typed,typed:typed,unsafe:function(t,r=[],n={}){2===arguments.length&&!Array.isArray(r)&&(n=r,r=[]);const s=new Query([t],r,e,cancel,{prepare:!1,...n,simple:"simple"in n?n.simple:0===r.length});return s},notify:notify,array:array,json:json,file:function(t,r=[],n={}){2===arguments.length&&!Array.isArray(r)&&(n=r,r=[]);const s=new Query([],r,(r=>{U.readFile(t,"utf8",((t,n)=>{if(t)return r.reject(t);r.strings=[n],e(r)}))}),cancel,{...n,simple:"simple"in n?n.simple:0===r.length});return s}}),sql;function typed(e,t){return new Parameter(e,t)}function sql(t,...n){return t&&Array.isArray(t.raw)?new Query(t,n,e,cancel):"string"!=typeof t||n.length?new Builder(t,n):new Identifier(r.transform.column.to?r.transform.column.to(t):t)}}async function listen(e,t,n){const s={fn:t,onlisten:n},o=listen.sql||(listen.sql=Postgres({...r,max:1,idle_timeout:null,max_lifetime:null,fetch_types:!1,onclose(){Object.entries(listen.channels).forEach((([e,{listeners:t}])=>{delete listen.channels[e],Promise.all(t.map((t=>listen(e,t.fn,t.onlisten).catch((()=>{})))))}))},onnotify(e,t){e in listen.channels&&listen.channels[e].listeners.forEach((e=>e.fn(t)))}})),a=listen.channels||(listen.channels={});if(e in a){a[e].listeners.push(s);const t=await a[e].result;return s.onlisten&&s.onlisten(),{state:t.state,unlisten:unlisten}}a[e]={result:o`listen ${o.unsafe('"'+e.replace(/"/g,'""')+'"')}`,listeners:[s]};const i=await a[e].result;return s.onlisten&&s.onlisten(),{state:i.state,unlisten:unlisten};async function unlisten(){if(e in a!=!1&&(a[e].listeners=a[e].listeners.filter((e=>e!==s)),!a[e].listeners.length))return delete a[e],o`unlisten ${o.unsafe('"'+e.replace(/"/g,'""')+'"')}`}}async function notify(e,t){return await(h`select pg_notify(${e}, ${""+t})`)}function move(e,t){return e.queue.remove(e),t.push(e),e.queue=t,t===u?e.idleTimer.start():e.idleTimer.cancel(),e}function json(e){return new Parameter(e,3802)}function array(e,t){return Array.isArray(e)?new Parameter(e,t||(e.length?Y(e)||25:0),r.shared.typeArrayMap):array(Array.from(arguments))}function go(e,t){return e.execute(t)?move(e,f):move(e,d)}function cancel(e){return new Promise(((t,n)=>{e.state?e.active?Connection(r).cancel(e.state,t,n):e.cancelled={resolve:t,reject:n}:(o.remove(e),e.cancelled=!0,e.reject(G.generic("57014","canceling statement due to user request")),t())}))}async function destroy(e){for(await Promise.all(m.map((e=>e.terminate())));o.length;)o.shift().reject(G.connection("CONNECTION_DESTROYED",r));e()}function connect(e,t){return move(e,a),e.connect(t),e}function onend(e){move(e,l)}function onopen(e){if(0===o.length)return move(e,u);let t=Math.ceil(o.length/(a.length+1)),r=!0;for(;r&&o.length&&t-- >0;){const t=o.shift();if(t.reserve)return t.reserve(e);r=e.execute(t)}move(e,r?f:d)}function onclose(e,t){move(e,c),e.reserved=null,e.onclose&&(e.onclose(t),e.onclose=null),r.onclose&&r.onclose(e.id),o.length&&connect(e,o.shift())}}function tsa(e,t,r){const n=e.target_session_attrs||t.searchParams.get("target_session_attrs")||r.PGTARGETSESSIONATTRS;if(!n||["read-write","read-only","primary","standby","prefer-standby"].includes(n))return n;throw new Error("target_session_attrs "+n+" is not supported")}function backoff(e){return(.5+Math.random()/2)*Math.min(3**e/100,20)}function max_lifetime(){return 60*(30+30*Math.random())}function parseTransform(e){return{undefined:e.undefined,column:{from:"function"==typeof e.column?e.column:e.column&&e.column.from,to:e.column&&e.column.to},value:{from:"function"==typeof e.value?e.value:e.value&&e.value.from,to:e.value&&e.value.to},row:{from:"function"==typeof e.row?e.row:e.row&&e.row.from,to:e.row&&e.row.to}}}Object.assign(Postgres,{PostgresError:PostgresError,toPascal:toPascal,pascal:ee,toCamel:toCamel,camel:Z,toKebab:toKebab,kebab:te,fromPascal:fromPascal,fromCamel:fromCamel,fromKebab:fromKebab,BigInt:{to:20,from:[20],parse:e=>BigInt(e),serialize:e=>e.toString()}});class PostgresJsPreparedQuery extends a{constructor(e,t,r,n,s,o,a){super({sql:t,params:r}),this.client=e,this.queryString=t,this.params=r,this.logger=n,this.fields=s,this._isResponseInArrayMode=o,this.customResultMapper=a}static[o]="PostgresJsPreparedQuery";async execute(e={}){return i.startActiveSpan("drizzle.execute",(async t=>{const r=c(this.params,e);t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.logger.logQuery(this.queryString,r);const{fields:n,queryString:s,client:o,joinsNotNullableMap:a,customResultMapper:u}=this;if(!n&&!u)return i.startActiveSpan("drizzle.driver.execute",(()=>o.unsafe(s,r)));const f=await i.startActiveSpan("drizzle.driver.execute",(()=>(t?.setAttributes({"drizzle.query.text":s,"drizzle.query.params":JSON.stringify(r)}),o.unsafe(s,r).values())));return i.startActiveSpan("drizzle.mapResponse",(()=>u?u(f):f.map((e=>l(n,e,a)))))}))}all(e={}){return i.startActiveSpan("drizzle.execute",(async t=>{const r=c(this.params,e);return t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.logger.logQuery(this.queryString,r),i.startActiveSpan("drizzle.driver.execute",(()=>(t?.setAttributes({"drizzle.query.text":this.queryString,"drizzle.query.params":JSON.stringify(r)}),this.client.unsafe(this.queryString,r))))}))}isResponseInArrayMode(){return this._isResponseInArrayMode}}class PostgresJsSession extends n{constructor(e,t,r,n={}){super(t),this.client=e,this.schema=r,this.options=n,this.logger=n.logger??new s}static[o]="PostgresJsSession";logger;prepareQuery(e,t,r,n,s){return new PostgresJsPreparedQuery(this.client,e.sql,e.params,this.logger,t,n,s)}query(e,t){return this.logger.logQuery(e,t),this.client.unsafe(e,t).values()}queryObjects(e,t){return this.client.unsafe(e,t)}transaction(e,t){return this.client.begin((async r=>{const n=new PostgresJsSession(r,this.dialect,this.schema,this.options),s=new PostgresJsTransaction(this.dialect,n,this.schema);return t&&await s.setTransaction(t),e(s)}))}}class PostgresJsTransaction extends u{constructor(e,t,r,n=0){super(e,t,r,n),this.session=t}static[o]="PostgresJsTransaction";transaction(e){return this.session.client.savepoint((t=>{const r=new PostgresJsSession(t,this.dialect,this.schema,this.session.options),n=new PostgresJsTransaction(this.dialect,r,this.schema);return e(n)}))}}class PostgresJsDatabase extends h{static[o]="PostgresJsDatabase"}function construct(e,t={}){const transparentParser=e=>e;for(const t of["1184","1082","1083","1114","1182","1185","1115","1231"])e.options.parsers[t]=transparentParser,e.options.serializers[t]=transparentParser;e.options.serializers[114]=transparentParser,e.options.serializers[3802]=transparentParser;const r=new d({casing:t.casing});let n,s;if(!0===t.logger?n=new g:!1!==t.logger&&(n=t.logger),t.schema){const e=p(t.schema,m);s={fullSchema:t.schema,schema:e.tables,tableNamesMap:e.tableNamesMap}}const o=new PostgresJsSession(e,r,s,{logger:n}),a=new PostgresJsDatabase(r,o,s);return a.$client=e,a}function drizzle(...e){if("string"==typeof e[0]){return construct(Postgres(e[0]),e[1])}if(f(e[0])){const{connection:t,client:r,...n}=e[0];if(r)return construct(r,n);if("object"==typeof t&&void 0!==t.url){const{url:e,...r}=t;return construct(Postgres(e,r),n)}return construct(Postgres(t),n)}return construct(e[0],e[1])}(drizzle||(drizzle={})).mock=function(e){return construct({options:{parsers:{},serializers:{}}},e)};var pe={exports:{}};const me=y(v),he=y(S),ge={UV_UDP_REUSEADDR:4,dlopen:{RTLD_LAZY:1,RTLD_NOW:2,RTLD_GLOBAL:256,RTLD_LOCAL:0,RTLD_DEEPBIND:8},errno:{E2BIG:7,EACCES:13,EADDRINUSE:98,EADDRNOTAVAIL:99,EAFNOSUPPORT:97,EAGAIN:11,EALREADY:114,EBADF:9,EBADMSG:74,EBUSY:16,ECANCELED:125,ECHILD:10,ECONNABORTED:103,ECONNREFUSED:111,ECONNRESET:104,EDEADLK:35,EDESTADDRREQ:89,EDOM:33,EDQUOT:122,EEXIST:17,EFAULT:14,EFBIG:27,EHOSTUNREACH:113,EIDRM:43,EILSEQ:84,EINPROGRESS:115,EINTR:4,EINVAL:22,EIO:5,EISCONN:106,EISDIR:21,ELOOP:40,EMFILE:24,EMLINK:31,EMSGSIZE:90,EMULTIHOP:72,ENAMETOOLONG:36,ENETDOWN:100,ENETRESET:102,ENETUNREACH:101,ENFILE:23,ENOBUFS:105,ENODATA:61,ENODEV:19,ENOENT:2,ENOEXEC:8,ENOLCK:37,ENOLINK:67,ENOMEM:12,ENOMSG:42,ENOPROTOOPT:92,ENOSPC:28,ENOSR:63,ENOSTR:60,ENOSYS:38,ENOTCONN:107,ENOTDIR:20,ENOTEMPTY:39,ENOTSOCK:88,ENOTSUP:95,ENOTTY:25,ENXIO:6,EOPNOTSUPP:95,EOVERFLOW:75,EPERM:1,EPIPE:32,EPROTO:71,EPROTONOSUPPORT:93,EPROTOTYPE:91,ERANGE:34,EROFS:30,ESPIPE:29,ESRCH:3,ESTALE:116,ETIME:62,ETIMEDOUT:110,ETXTBSY:26,EWOULDBLOCK:11,EXDEV:18},signals:{SIGHUP:1,SIGINT:2,SIGQUIT:3,SIGILL:4,SIGTRAP:5,SIGABRT:6,SIGIOT:6,SIGBUS:7,SIGFPE:8,SIGKILL:9,SIGUSR1:10,SIGSEGV:11,SIGUSR2:12,SIGPIPE:13,SIGALRM:14,SIGTERM:15,SIGCHLD:17,SIGSTKFLT:16,SIGCONT:18,SIGSTOP:19,SIGTSTP:20,SIGTTIN:21,SIGTTOU:22,SIGURG:23,SIGXCPU:24,SIGXFSZ:25,SIGVTALRM:26,SIGPROF:27,SIGWINCH:28,SIGIO:29,SIGPOLL:29,SIGPWR:30,SIGSYS:31},priority:{PRIORITY_LOW:19,PRIORITY_BELOW_NORMAL:10,PRIORITY_NORMAL:0,PRIORITY_ABOVE_NORMAL:-7,PRIORITY_HIGH:-14,PRIORITY_HIGHEST:-20}},availableParallelism=()=>8,arch=()=>"",machine=()=>"",endianness=()=>"LE",cpus=()=>{const e={model:"",speed:0,times:{user:0,nice:0,sys:0,idle:0,irq:0}};return Array.from({length:8},(()=>e))},getPriority=()=>0,ye=E("os.setPriority"),homedir=()=>"/",tmpdir=()=>"/tmp",Ee="/dev/null",freemem=()=>0,totalmem=()=>0,loadavg=()=>[0,0,0],uptime=()=>0,hostname=()=>"",networkInterfaces=()=>({lo0:[{address:"127.0.0.1",netmask:"255.0.0.0",family:"IPv4",mac:"00:00:00:00:00:00",internal:!0,cidr:"127.0.0.1/8"},{address:"::1",netmask:"ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff",family:"IPv6",mac:"00:00:00:00:00:00",internal:!0,cidr:"::1/128",scopeid:0},{address:"fe80::1",netmask:"ffff:ffff:ffff:ffff::",family:"IPv6",mac:"00:00:00:00:00:00",internal:!0,cidr:"fe80::1/64",scopeid:1}]}),platform=()=>"linux",type=()=>"Linux",release=()=>"",version$2=()=>"",userInfo=e=>{const encode=r=>{if(e?.encoding){const n=t.from(r);return"buffer"===e.encoding?n:n.toString(e.encoding)}return r};return{gid:1e3,uid:1e3,homedir:encode("/"),shell:encode("/bin/sh"),username:encode("root")}},we={arch:arch,availableParallelism:availableParallelism,constants:ge,cpus:cpus,EOL:"\n",endianness:endianness,devNull:Ee,freemem:freemem,getPriority:getPriority,homedir:homedir,hostname:hostname,loadavg:loadavg,machine:machine,networkInterfaces:networkInterfaces,platform:platform,release:release,setPriority:ye,tmpdir:tmpdir,totalmem:totalmem,type:type,uptime:uptime,userInfo:userInfo,version:version$2},be=y(Object.freeze(Object.defineProperty({__proto__:null,EOL:"\n",arch:arch,availableParallelism:availableParallelism,constants:ge,cpus:cpus,default:we,devNull:Ee,endianness:endianness,freemem:freemem,getPriority:getPriority,homedir:homedir,hostname:hostname,loadavg:loadavg,machine:machine,networkInterfaces:networkInterfaces,platform:platform,release:release,setPriority:ye,tmpdir:tmpdir,totalmem:totalmem,type:type,uptime:uptime,userInfo:userInfo,version:version$2},Symbol.toStringTag,{value:"Module"}))),ve=y(w);const Se=me,_e=he,Oe=be,Ie=ve,Pe={version:"16.5.0"}.version,Ne=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/gm;function _debug(e){console.log(`[dotenv@${Pe}][DEBUG] ${e}`)}function _dotenvKey(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:b.env.DOTENV_KEY&&b.env.DOTENV_KEY.length>0?b.env.DOTENV_KEY:""}function _instructions(e,t){let r;try{r=new URL(t)}catch(e){if("ERR_INVALID_URL"===e.code){const e=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw e.code="INVALID_DOTENV_KEY",e}throw e}const n=r.password;if(!n){const e=new Error("INVALID_DOTENV_KEY: Missing key part");throw e.code="INVALID_DOTENV_KEY",e}const s=r.searchParams.get("environment");if(!s){const e=new Error("INVALID_DOTENV_KEY: Missing environment part");throw e.code="INVALID_DOTENV_KEY",e}const o=`DOTENV_VAULT_${s.toUpperCase()}`,a=e.parsed[o];if(!a){const e=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${o} in your .env.vault file.`);throw e.code="NOT_FOUND_DOTENV_ENVIRONMENT",e}return{ciphertext:a,key:n}}function _vaultPath(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(const r of e.path)Se.existsSync(r)&&(t=r.endsWith(".vault")?r:`${r}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=_e.resolve(b.cwd(),".env.vault");return Se.existsSync(t)?t:null}function _resolveHome(e){return"~"===e[0]?_e.join(Oe.homedir(),e.slice(1)):e}const Te={configDotenv:function(e){const t=_e.resolve(b.cwd(),".env");let r="utf8";const n=Boolean(e&&e.debug);e&&e.encoding?r=e.encoding:n&&_debug("No encoding is specified. UTF-8 is used by default");let s,o=[t];if(e&&e.path)if(Array.isArray(e.path)){o=[];for(const t of e.path)o.push(_resolveHome(t))}else o=[_resolveHome(e.path)];const a={};for(const t of o)try{const n=Te.parse(Se.readFileSync(t,{encoding:r}));Te.populate(a,n,e)}catch(e){n&&_debug(`Failed to load ${t} ${e.message}`),s=e}let i=b.env;return e&&null!=e.processEnv&&(i=e.processEnv),Te.populate(i,a,e),s?{parsed:a,error:s}:{parsed:a}},_configVault:function(e){Boolean(e&&e.debug)&&_debug("Loading env from encrypted .env.vault");const t=Te._parseVault(e);let r=b.env;return e&&null!=e.processEnv&&(r=e.processEnv),Te.populate(r,t,e),{parsed:t}},_parseVault:function(e){const t=_vaultPath(e),r=Te.configDotenv({path:t});if(!r.parsed){const e=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw e.code="MISSING_DATA",e}const n=_dotenvKey(e).split(","),s=n.length;let o;for(let e=0;e<s;e++)try{const t=_instructions(r,n[e].trim());o=Te.decrypt(t.ciphertext,t.key);break}catch(t){if(e+1>=s)throw t}return Te.parse(o)},config:function(e){if(0===_dotenvKey(e).length)return Te.configDotenv(e);const t=_vaultPath(e);return t?Te._configVault(e):(r=`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`,console.log(`[dotenv@${Pe}][WARN] ${r}`),Te.configDotenv(e));var r},decrypt:function(e,r){const n=t.from(r.slice(-64),"hex");let s=t.from(e,"base64");const o=s.subarray(0,12),a=s.subarray(-16);s=s.subarray(12,-16);try{const e=Ie.createDecipheriv("aes-256-gcm",n,o);return e.setAuthTag(a),`${e.update(s)}${e.final()}`}catch(e){const t=e instanceof RangeError,r="Invalid key length"===e.message,n="Unsupported state or unable to authenticate data"===e.message;if(t||r){const e=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw e.code="INVALID_DOTENV_KEY",e}if(n){const e=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw e.code="DECRYPTION_FAILED",e}throw e}},parse:function(e){const t={};let r,n=e.toString();for(n=n.replace(/\r\n?/gm,"\n");null!=(r=Ne.exec(n));){const e=r[1];let n=r[2]||"";n=n.trim();const s=n[0];n=n.replace(/^(['"`])([\s\S]*)\1$/gm,"$2"),'"'===s&&(n=n.replace(/\\n/g,"\n"),n=n.replace(/\\r/g,"\r")),t[e]=n}return t},populate:function(e,t,r={}){const n=Boolean(r&&r.debug),s=Boolean(r&&r.override);if("object"!=typeof t){const e=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw e.code="OBJECT_REQUIRED",e}for(const r of Object.keys(t))Object.prototype.hasOwnProperty.call(e,r)?(!0===s&&(e[r]=t[r]),n&&_debug(!0===s?`"${r}" is already defined and WAS overwritten`:`"${r}" is already defined and was NOT overwritten`)):e[r]=t[r]}};pe.exports.configDotenv=Te.configDotenv,pe.exports._configVault=Te._configVault,pe.exports._parseVault=Te._parseVault;var Ae=pe.exports.config=Te.config;pe.exports.decrypt=Te.decrypt,pe.exports.parse=Te.parse,pe.exports.populate=Te.populate,pe.exports=Te;export{Postgres as P,he as a,me as b,Ae as c,drizzle as d,ve as r};
//# sourceMappingURL=main.mjs.map
