import{d as e,l as o}from"./index-8Htcofqc.mjs";import{_ as r}from"./companies-l5PKOmvG.mjs";import{o as a}from"./company.schema-C_XODBeq.mjs";import{c as t,N as n,f as i,a7 as s}from"../nitro/nitro.mjs";import{d as c}from"./company-categories-CgBd9Wjc.mjs";import{f as m}from"./cloudinary-BTIR3bRv.mjs";import{d as p}from"../_/index2.mjs";import"../_/main.mjs";import"node:events";import"node:buffer";import"node:stream";import"../_/server.mjs";import"node:path";import"./auth-BsEI6_U5.mjs";import"node:net";import"node:process";import"node:timers";import"node:async_hooks";import"node:url";import"node:stream/web";import"node:crypto";import"./categories-B1A9pQfz.mjs";import"node:querystring";const d=s("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",10);function I(e){return`${function(e,o=50){return e.normalize("NFKD").toLowerCase().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"").slice(0,o).replace(/-+$/g,"")}(e)}-${d()}`}async function l({images:e,companyId:o,companySlug:r,type:a}){const t=[];for(const n of e){const e=await m({file:n,companyId:o,companySlug:r,type:a});if(e instanceof Error)throw e;const{secure_url:i,public_id:s}=e;t.push({secureUrl:i,publicId:s})}return t}const u=e("app_lib_api_companies_mutations_create-company_ts--createCompany_createServerFn_handler","/_server",((e,o)=>y.__executeServer(e,o))),y=t({method:"POST"}).validator((e=>{const o=p(e,{files:["logo","gallery"],arrays:["categories","gallery"],booleans:["rqth"]});return n(a,o)})).handler(u,(async({data:e})=>{const{logo:a,gallery:t,categories:n,...s}=e;try{await o.transaction((async e=>{const m=await async function(e){const[a]=await o.insert(r).values({...e,created_by:e.user_id,slug:I(e.name)}).returning();return a}(s);if(await async function(e,r){await o.insert(c).values(r.map((o=>({company_id:e,category_id:o}))))}(m.id,n),a&&a.size>0){const o=await l({type:"logo",images:[a],companyId:m.id,companySlug:m.slug});await e.update(r).set({logo:o[0]}).where(i(r.id,m.id))}if(t&&t.length>0){const o=await l({type:"gallery",images:t,companyId:m.id,companySlug:m.slug});await e.update(r).set({gallery:o}).where(i(r.id,m.id))}}))}catch(e){console.error(e)}}));export{u as createCompany_createServerFn_handler};
//# sourceMappingURL=create-company-CP4w5uGh.mjs.map
