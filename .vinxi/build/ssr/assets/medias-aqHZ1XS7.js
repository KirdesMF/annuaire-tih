import{jsx as e,jsxs as t}from"react/jsx-runtime";import{useSuspenseQuery as T,useMutation as F}from"@tanstack/react-query";import{toast as d}from"sonner";import{P as v}from"./plus-BVAK8_Jr.js";import{L as x}from"./label-DH_rTUQU.js";import{u as z}from"./use-image-preview-D0S5Wc-4.js";import{decode as y}from"decode-formdata";import{U as M,L as G,G as K}from"./company.schema-5gxzbh_J.js";import*as h from"valibot";import{createServerFn as p}from"@tanstack/start-client-core";import{k as u,J as N,y as O,n as P}from"./ssr-Bxxdisao.js";import{T as C}from"./trash-BEra1ZVi.js";import"react";import"@tanstack/react-router";import"radix-ui";import"drizzle-orm/pg-core";import"better-auth/react";import"better-auth/client/plugins";import"zustand";import"@tanstack/router-core";import"@tanstack/start-server-core";import"cmdk";import"clsx";import"tailwind-merge";import"@tanstack/react-query-devtools";import"drizzle-orm";import"nanoid";import"@tanstack/react-router-with-query";import"tiny-invariant";import"node:stream";import"isbot";import"react-dom/server";const k=u("app_lib_api_companies_mutations_update-company-medias_ts--updateCompanyMedia_createServerFn_handler","/_server"),B=p({method:"POST"}).validator(l=>{const o=y(l,{files:["logo","gallery"],arrays:["gallery","gallery_public_id"]});return h.parse(M,o)}).handler(k),R=u("app_lib_api_companies_mutations_update-company-medias_ts--updateCompanyLogo_createServerFn_handler","/_server");p({method:"POST"}).validator(l=>{const o=y(l,{files:["logo"]});return h.parse(G,o)}).handler(R);const E=u("app_lib_api_companies_mutations_update-company-medias_ts--updateCompanyGallery_createServerFn_handler","/_server");p({method:"POST"}).validator(l=>{const o=y(l,{files:["gallery"],arrays:["gallery","gallery_public_id"]});return h.parse(K,o)}).handler(E);const J=u("app_lib_api_companies_mutations_delete-company-media_ts--deleteCompanyLogo_createServerFn_handler","/_server");p({method:"POST"}).validator(l=>l).handler(J);const A=u("app_lib_api_companies_mutations_delete-company-media_ts--deleteCompanyMedia_createServerFn_handler","/_server"),H=p({method:"POST"}).validator(l=>l).handler(A),we=function(){const o=N.useParams(),m=N.useRouteContext(),L=N.useNavigate(),{data:a}=T(O(o.slug)),{imagePreviews:c,readImage:q,setImagePreviews:S}=z(),{mutate:D,isPending:j}=F({mutationFn:P(B)}),{mutate:w,isPending:f}=F({mutationFn:P(H)});function _(r,i,s){const n=r.target.files?.[0];n&&q({type:i,file:n,index:s})}function U({companyId:r,publicId:i}){w({data:{companyId:r,publicId:i,type:"logo"}},{onSuccess:()=>{m.queryClient.invalidateQueries({queryKey:["user","companies"]}),m.queryClient.invalidateQueries({queryKey:["company",o.slug]}),S(s=>({...s,logo:void 0})),d.success("Logo supprimé avec succès")}})}function I({companyId:r,publicId:i,index:s}){w({data:{companyId:r,publicId:i,type:"gallery",index:s}},{onSuccess:()=>{m.queryClient.invalidateQueries({queryKey:["user","companies"]}),m.queryClient.invalidateQueries({queryKey:["company",o.slug]}),S(n=>({...n,gallery:n.gallery.filter((g,b)=>b!==s)})),d.success("Image supprimée avec succès")}})}function Q(r){r.preventDefault();const i=new FormData(r.target),s=y(i,{files:["logo","gallery"],arrays:["gallery","gallery_public_id"]}),n=h.safeParse(M,s,{abortPipeEarly:!0});if(!n.success){d.error(e("div",{children:n.issues.map((g,b)=>e("p",{children:g.message},b))}));return}D({data:i},{onSuccess:()=>{m.queryClient.invalidateQueries({queryKey:["user","companies"]}),m.queryClient.invalidateQueries({queryKey:["company",o.slug]}),d.success("Images mises à jour avec succès"),L({to:"/compte/entreprises"})},onError:g=>{console.error(g),d.error("Une erreur est survenue lors de la mise à jour des images")}})}return e("div",{className:"container py-6",children:t("form",{onSubmit:Q,className:"flex flex-col gap-4 items-center",children:[e("input",{type:"hidden",name:"companyId",value:a.id}),t("div",{className:"flex flex-col gap-2 justify-center",children:[t("fieldset",{className:"border rounded-sm border-gray-300 p-4 w-max",children:[e("legend",{className:"text-xs font-medium  bg-white px-2",children:"Logo"}),t("div",{className:"grid gap-2",children:[t(x,{className:"relative flex flex-col gap-1 outline-none group",children:[e("span",{className:"text-xs font-medium",children:"Logo (max. 3MB)"}),t("div",{className:"w-35 h-40 bg-gray-100 border border-gray-300 rounded-sm grid place-items-center group-focus-within:border-gray-500",children:[c.logo||a.logo?.secureUrl?e("img",{src:c.logo||a.logo?.secureUrl,alt:"Logo",className:"w-full h-full object-cover"}):e(v,{className:"size-8 rounded-full bg-gray-400 p-1 text-white"}),e("input",{type:"file",className:"absolute inset-0 opacity-0",name:"logo",onChange:r=>_(r,"logo"),accept:"image/*"}),e("input",{type:"hidden",name:"logo_public_id",value:a.logo?.publicId})]})]}),e("button",{type:"button",className:"text-xs font-medium text-white bg-primary p-2 rounded-sm w-max",onClick:()=>U({companyId:a.id,publicId:a.logo?.publicId||""}),children:f?"...":e(C,{className:"size-5"})})]})]}),t("fieldset",{className:"border rounded-sm border-gray-300 p-4",children:[e("legend",{className:"text-xs font-medium  bg-white px-2",children:"Galerie"}),t("div",{className:"flex gap-2",children:[t("div",{className:"flex flex-col gap-2",children:[t(x,{className:"relative flex flex-col gap-1 outline-none group",children:[e("span",{className:"text-xs font-medium",children:"Image 1 (max. 2MB)"}),t("div",{className:"w-35 h-40 bg-gray-100 border border-gray-300 rounded-sm grid place-items-center group-focus-within:border-gray-500",children:[c.gallery[0]||a.gallery?.[0]?.secureUrl?e("img",{src:c.gallery[0]||a.gallery?.[0].secureUrl,alt:"gallery 1",className:"w-full h-full object-cover"}):e(v,{className:"size-8 rounded-full bg-gray-400 p-1 text-white"}),e("input",{type:"file",className:"absolute inset-0 opacity-0",name:"gallery[0]",onChange:r=>_(r,"gallery",0),accept:"image/*"}),e("input",{type:"hidden",name:"gallery_public_id[0]",value:a.gallery?.[0]?.publicId})]})]}),e("button",{type:"button",className:"text-xs font-medium text-white bg-primary p-2 rounded-sm w-max",onClick:()=>I({companyId:a.id,publicId:a.gallery?.[0]?.publicId||"",index:0}),children:f?"...":e(C,{className:"size-5"})})]}),t("div",{className:"flex flex-col gap-2",children:[t(x,{className:"relative flex flex-col gap-1 outline-none group",children:[e("span",{className:"text-xs font-medium",children:"Image 2 (max. 2MB)"}),t("div",{className:"w-35 h-40 bg-gray-100 border border-gray-300 rounded-sm grid place-items-center group-focus-within:border-gray-500",children:[c.gallery[1]||a.gallery?.[1]?.secureUrl?e("img",{src:c.gallery[1]||a.gallery?.[1].secureUrl,alt:"gallery 2",className:"w-full h-full object-cover"}):e(v,{className:"size-8 rounded-full bg-gray-400 p-1 text-white"}),e("input",{type:"file",className:"absolute inset-0 opacity-0",name:"gallery[1]",onChange:r=>_(r,"gallery",1),accept:"image/*"}),e("input",{type:"hidden",name:"gallery_public_id[1]",value:a.gallery?.[1]?.publicId})]})]}),e("button",{type:"button",className:"text-xs font-medium text-white bg-primary p-2 rounded-sm w-max",onClick:()=>I({companyId:a.id,publicId:a.gallery?.[1]?.publicId||"",index:1}),children:f?"...":e(C,{className:"size-5"})})]})]})]})]}),e("button",{type:"submit",className:"text-xs font-medium text-white bg-primary px-4 py-2 rounded-sm w-max",children:j?"En cours...":"Mettre à jour"})]})})};export{we as component};
