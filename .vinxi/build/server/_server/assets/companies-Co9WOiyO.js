import{eq as p}from"drizzle-orm";import{c as v,d as h}from"./index-8Htcofqc.js";import{C as k,c as n,a as _}from"./company-categories-Dsd3WCXy.js";import*as e from"valibot";import{a as x}from"./auth.server-CEln8Kin.js";import{redirect as F}from"@tanstack/react-router";import{v2 as S}from"cloudinary";import{decode as I}from"decode-formdata";import{c as z}from"./categories-BGVwlHfX.js";import{createServerFn as b}from"@tanstack/start-client-core";import{getWebRequest as T}from"@tanstack/start-server-core";import"tiny-invariant";import"drizzle-orm/postgres-js";import"postgres";import"dotenv";import"drizzle-orm/pg-core";import"better-auth";import"better-auth/adapters/drizzle";import"better-auth/plugins";import"better-auth/react-start";const O=e.object({name:e.pipe(e.string(),e.nonEmpty("Veuillez entrer le nom de l'entreprise"),e.maxLength(255,"Le nom de l'entreprise doit contenir au plus 255 caractères")),siret:e.pipe(e.string(),e.nonEmpty("Veuillez entrer le siret de l'entreprise"),e.length(14,"Le siret de l'entreprise doit contenir 14 caractères")),categories:e.pipe(e.array(e.string()),e.minLength(1,"Veuillez sélectionner au moins une catégorie"),e.maxLength(3,"Veuillez sélectionner au plus 3 catégories")),business_owner:e.union([e.literal(""),e.pipe(e.string(),e.nonEmpty("Veuillez entrer le nom du responsable de l'entreprise"),e.maxLength(255,"Le nom du responsable de l'entreprise doit contenir au plus 255 caractères"))]),description:e.union([e.literal(""),e.pipe(e.string(),e.maxLength(1500,"La description de l'entreprise doit contenir au plus 1500 caractères"))]),website:e.union([e.literal(""),e.pipe(e.string(),e.url("Veuillez entrer une url valide"))]),location:e.optional(e.union([e.literal(""),e.pipe(e.string(),e.maxLength(255,"La localisation doit contenir au plus 255 caractères"))])),service_area:e.union([e.literal(""),e.pipe(e.string(),e.maxLength(255,"La zone de service doit contenir au plus 255 caractères"))]),subdomain:e.union([e.literal(""),e.pipe(e.string(),e.maxLength(100,"Le sous-domaine doit contenir au plus 100 caractères"))]),email:e.union([e.literal(""),e.pipe(e.string(),e.email("Veuillez entrer une adresse email valide"))]),phone:e.union([e.literal(""),e.pipe(e.string(),e.maxLength(24,"Le numéro de téléphone doit contenir au plus 24 caractères"))]),work_mode:e.nullable(e.picklist(k)),rqth:e.optional(e.boolean()),logo:e.optional(e.pipe(e.instance(File),e.mimeType(["image/png","image/jpeg","image/jpg","image/webp"],"Veuillez entrer un fichier valide pour le logo"),e.maxSize(1024*1024*3,"La taille du fichier doit être inférieure à 3MB"))),gallery:e.optional(e.pipe(e.array(e.pipe(e.instance(File),e.mimeType(["image/png","image/jpeg","image/jpg","image/webp"],"Veuillez entrer un fichier valide pour la galerie"),e.maxSize(1024*1024*2,"La taille du fichier doit être inférieure à 2MB"))),e.maxLength(2,"Veuillez entrer au plus 2 images"))),facebook:e.union([e.literal(""),e.pipe(e.string(),e.url("Veuillez entrer une url valide"),e.startsWith("https://www.facebook.com/","Veuillez entrer une url facebook valide"))]),instagram:e.union([e.literal(""),e.pipe(e.string(),e.url("Veuillez entrer une url valide"),e.startsWith("https://www.instagram.com/","Veuillez entrer une url instagram valide"))]),linkedin:e.union([e.literal(""),e.pipe(e.string(),e.url("Veuillez entrer une url valide"),e.startsWith("https://www.linkedin.com/company/","Veuillez entrer une url linkedin valide"))]),calendly:e.union([e.literal(""),e.pipe(e.string(),e.url("Veuillez entrer une url valide"),e.startsWith("https://calendly.com/","Veuillez entrer une url calendly valide"))])});S.config({cloud_name:process.env.CLOUDINARY_CLOUD_NAME,api_key:process.env.CLOUDINARY_API_KEY,api_secret:process.env.CLOUDINARY_API_SECRET});async function C({type:r,file:i,companyId:o,companyName:a}){const c=r==="logo"?`companies/${a}/logo`:`companies/${a}/gallery`;try{const u=await i.arrayBuffer();return await new Promise((y,f)=>{S.uploader.upload_stream({folder:c,resource_type:"auto",public_id:`${o}-${Date.now()}`,allowed_formats:["jpg","png","jpeg","webp"]},(g,d)=>{g&&f(g),d&&y({secure_url:d.secure_url,public_id:d.public_id})}).end(Buffer.from(u))})}catch(u){throw console.error(u),new Error("Failed to upload image to Cloudinary")}}const A=v("app_lib_api_companies_ts--addCompany_createServerFn_handler","/_server",(r,i)=>D.__executeServer(r,i)),R=v("app_lib_api_companies_ts--deleteCompany_createServerFn_handler","/_server",(r,i)=>q.__executeServer(r,i)),j=v("app_lib_api_companies_ts--getCompany_createServerFn_handler","/_server",(r,i)=>N.__executeServer(r,i)),D=b({method:"POST"}).validator(r=>{const i=I(r,{files:["logo","gallery"],arrays:["categories","gallery"],booleans:["rqth"]});return e.parse(O,i)}).handler(A,async({data:r})=>{const i=T();if(!i)throw new Error("Request not found");const o=await x.api.getSession({headers:i.headers});if(!o)throw F({to:"/login"});const{logo:a,gallery:c,categories:u,facebook:L,instagram:y,linkedin:f,calendly:g,...d}=r;try{await h.transaction(async s=>{const[l]=await s.insert(n).values({...d,social_media:{facebook:L,instagram:y,linkedin:f,calendly:g},user_id:o.user.id,created_by:o.user.id}).returning();if(a&&a.size>0){const t=await C({file:a,companyId:l.id,companyName:l.name,type:"logo"});if(t instanceof Error)throw t;const{secure_url:w,public_id:m}=t;await s.update(n).set({logo:{secureUrl:w,publicId:m}}).where(p(n.id,l.id))}if(c&&c.length>0){const t=[];for(const w of c){if(t.length>=2)break;const m=await C({file:w,companyId:l.id,companyName:l.name,type:"gallery"});if(m instanceof Error)throw m;const{secure_url:V,public_id:E}=m;t.push({secureUrl:V,publicId:E})}await s.update(n).set({gallery:t}).where(p(n.id,l.id))}await s.insert(_).values(u.map(t=>({company_id:l.id,category_id:t})))})}catch(s){console.error(s)}}),q=b({method:"POST"}).validator(r=>r).handler(R,async({data:r})=>{try{await h.delete(n).where(p(n.id,r))}catch(i){console.error(i)}}),N=b({method:"GET"}).validator(r=>r).handler(j,async({data:r})=>{try{const i=await h.select().from(n).where(p(n.id,r)).limit(1).then(a=>a[0]),o=await h.select().from(_).leftJoin(z,p(z.id,_.category_id)).where(p(_.company_id,i.id));return{...i,categories:o.map(a=>a.categories?.name)}}catch(i){console.error(i)}});export{A as addCompany_createServerFn_handler,R as deleteCompany_createServerFn_handler,j as getCompany_createServerFn_handler};
