import{jsxs as n,jsx as e}from"react/jsx-runtime";import{queryOptions as v,useQuery as L,useMutation as V}from"@tanstack/react-query";import{linkOptions as R,Link as l,useRouter as F,createRootRouteWithContext as M,Outlet as H,useLayoutEffect as A,HeadContent as E,ScriptOnce as O,Scripts as B}from"@tanstack/react-router";import{Popover as p,DropdownMenu as o,Avatar as h}from"radix-ui";import{i as D}from"./auth-BsEI6_U5.js";import{createAuthClient as P}from"better-auth/react";import{adminClient as Q}from"better-auth/client/plugins";import{toast as $,Toaster as G}from"sonner";import{a as b}from"./auth.server-DtTByMvE.js";import{create as j}from"zustand";import{and as W,sql as K,eq as U}from"drizzle-orm";import{c as q,d as J}from"./index-8Htcofqc.js";import{c as u}from"./companies-l5PKOmvG.js";import{createServerFn as x}from"@tanstack/start-client-core";import{useState as w,useEffect as X}from"react";import{Command as c}from"cmdk";import{c as d,u as Y}from"./cn-CR1u50KS.js";import{getWebRequest as N}from"@tanstack/start-server-core";import{ReactQueryDevtools as Z}from"@tanstack/react-query-devtools";import"drizzle-orm/pg-core";import"better-auth";import"better-auth/adapters/drizzle";import"better-auth/plugins";import"better-auth/react-start";import"resend";import"tiny-invariant";import"drizzle-orm/postgres-js";import"postgres";import"dotenv";import"nanoid";import"@tanstack/router-core";import"clsx";import"tailwind-merge";function ee(t){return n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",...t,children:[e("title",{children:"Linkedin"}),e("path",{fill:"currentColor",d:"M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037c-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85c3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.06 2.06 0 0 1-2.063-2.065a2.064 2.064 0 1 1 2.063 2.065m1.782 13.019H3.555V9h3.564zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0z"})]})}function te(t){return n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",...t,children:[e("title",{children:"Logout"}),e("path",{fill:"currentColor",d:"M5.616 20q-.691 0-1.153-.462T4 18.384V5.616q0-.691.463-1.153T5.616 4h5.903q.214 0 .357.143t.143.357t-.143.357t-.357.143H5.616q-.231 0-.424.192T5 5.616v12.769q0 .23.192.423t.423.192h5.904q.214 0 .357.143t.143.357t-.143.357t-.357.143zm12.444-7.5H9.692q-.213 0-.356-.143T9.192 12t.143-.357t.357-.143h8.368l-1.971-1.971q-.141-.14-.15-.338q-.01-.199.15-.364q.159-.165.353-.168q.195-.003.36.162l2.614 2.613q.242.243.242.566t-.243.566l-2.613 2.613q-.146.146-.347.153t-.366-.159q-.16-.165-.157-.357t.162-.35z"})]})}function re(t){return n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",...t,children:[e("title",{children:"Settings account"}),e("path",{fill:"currentColor",d:"M14.654 21.846q-.529 0-.9-.37t-.37-.899v-5.923q0-.529.37-.9t.9-.37h5.923q.529 0 .899.37t.37.9v5.923q0 .529-.37.899t-.899.37zM11 17.386V21h-.098q-.348 0-.576-.229t-.29-.571l-.263-2.092q-.479-.145-1.036-.454q-.556-.31-.947-.664l-1.915.824q-.317.14-.644.03t-.504-.415L3.648 15.57q-.177-.305-.104-.638t.348-.546l1.672-1.25q-.045-.272-.073-.559q-.03-.288-.03-.559q0-.252.03-.53q.028-.278.073-.626l-1.672-1.25q-.275-.213-.338-.555t.113-.648l1.06-1.8q.177-.287.504-.406t.644.021l1.896.804q.448-.373.97-.673q.52-.3 1.013-.464l.283-2.092q.061-.342.318-.571T10.96 3h2.08q.349 0 .605.229q.257.229.319.571l.263 2.112q.575.202 1.016.463t.909.654l1.992-.804q.318-.14.645-.021t.503.406l1.06 1.819q.177.306.104.641q-.073.336-.348.544l-1.216.911q-.176.135-.362.133t-.346-.173t-.148-.38t.183-.347l1.225-.908l-.994-1.7l-2.552 1.07q-.454-.499-1.193-.935q-.74-.435-1.4-.577L13 4h-1.994l-.312 2.689q-.756.161-1.39.52q-.633.358-1.26.985L5.55 7.15l-.994 1.7l2.169 1.62q-.125.336-.175.73t-.05.82q0 .38.05.755t.156.73l-2.15 1.645l.994 1.7l2.475-1.05q.6.606 1.363.999t1.612.588m.973-7.887q-1.046 0-1.773.724T9.473 12q0 .467.16.89t.479.777q.16.183.366.206q.207.023.384-.136q.177-.154.181-.355t-.154-.347q-.208-.2-.312-.47T10.473 12q0-.625.438-1.063t1.062-.437q.289 0 .565.116q.276.117.476.324q.146.148.338.134q.192-.015.346-.191q.154-.177.134-.381t-.198-.364q-.311-.3-.753-.469t-.908-.169m5.643 8.962q-.625 0-1.197.191q-.571.191-1.057.56q-.287.22-.44.445t-.153.456q0 .136.106.242t.242.105h5.097q.105 0 .177-.095q.07-.097.07-.252q0-.231-.152-.456q-.153-.225-.44-.444q-.486-.37-1.057-.561t-1.196-.191m0-.846q.528 0 .899-.37q.37-.371.37-.9t-.37-.899t-.9-.37q-.528 0-.899.37q-.37.37-.37.9q0 .528.37.898t.9.37"})]})}function ne(t){return n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",...t,children:[e("title",{children:"Entreprise"}),e("path",{fill:"currentColor",d:"M4.616 20q-.691 0-1.153-.462T3 18.384V8.616q0-.691.463-1.153T4.615 7H9V5.615q0-.69.463-1.153T10.616 4h2.769q.69 0 1.153.462T15 5.615V7h4.385q.69 0 1.152.463T21 8.616v9.769q0 .69-.463 1.153T19.385 20zm0-1h14.769q.23 0 .423-.192t.192-.424V8.616q0-.231-.192-.424T19.385 8H4.615q-.23 0-.423.192T4 8.616v9.769q0 .23.192.423t.423.192M10 7h4V5.615q0-.23-.192-.423T13.385 5h-2.77q-.23 0-.423.192T10 5.615zM4 19V8z"})]})}function ae(t){return n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",...t,children:[e("title",{children:"Add"}),e("path",{fill:"currentColor",d:"M18 20v-3h-3v-2h3v-3h2v3h3v2h-3v3zM3 21q-.825 0-1.412-.587T1 19V5q0-.825.588-1.412T3 3h14q.825 0 1.413.588T19 5v5h-2V8H3v11h13v2z"})]})}function oe(t){return n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",...t,children:[e("title",{children:"Dashboard"}),e("path",{fill:"currentColor",d:"M5.616 20q-.691 0-1.153-.462T4 18.384V5.616q0-.691.463-1.153T5.616 4h12.769q.69 0 1.153.463T20 5.616v12.769q0 .69-.462 1.153T18.384 20zm0-1H11.5V5H5.616q-.231 0-.424.192T5 5.616v12.769q0 .23.192.423t.423.192m6.885 0h5.885q.23 0 .423-.192t.192-.424V12h-6.5zm0-8H19V5.616q0-.231-.192-.424T18.384 5H12.5z"})]})}const se=P({plugins:[Q()]});function ie(){const{data:t}=se.useSession(),r=t?.user.role;return{isAdmin:D(r)&&(r==="admin"||r==="superadmin")}}const T=j(t=>({theme:null,onThemeLight:()=>{localStorage.setItem("theme","light"),document.documentElement.dataset.theme="light",t({theme:"light"})},onThemeDark:()=>{localStorage.setItem("theme","dark"),document.documentElement.dataset.theme="dark",t({theme:"dark"})},onThemeSystem:()=>{localStorage.removeItem("theme"),document.documentElement.dataset.theme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light",t({theme:"system"})},setTheme:r=>t({theme:r})})),le=q("app_lib_api_companies_queries_get-companies-by-term_ts--getCompaniesByTerm_createServerFn_handler","/_server",(t,r)=>S.__executeServer(t,r)),S=x({method:"GET"}).validator(t=>t).handler(le,async({data:t})=>{const a=t.split(/\s+/).filter(s=>s.length>0).map(s=>`${s}:*`).join(" & ");return await J.select().from(u).where(W(K`to_tsvector('french', ${u.name} || ' ' || ${u.subdomain} || ' ' || ${u.description}) @@ to_tsquery('french', ${a})`,U(u.status,"active")))});function ce(t){return v({queryKey:["companies",t],queryFn:({signal:r})=>S({data:t,signal:r}),enabled:t.length>=3})}function de(t,r){const[a,s]=w(t);return X(()=>{const m=setTimeout(()=>s(t),r);return()=>clearTimeout(m)},[t,r]),a}const me=c;function he({className:t,...r}){return e(c.Loading,{className:d("px-4 py-2 text-sm",t),...r})}function ue({className:t,ref:r,...a}){return e(c.Separator,{className:d("my-2 h-px w-full bg-gray-400",t),ref:r,...a})}function y({className:t,children:r,ref:a,...s}){return e(c.Empty,{className:d("px-4 py-2 text-sm",t),ref:a,...s,children:r})}function ge({className:t,...r}){return e(c.Input,{className:d(["w-full px-4 py-1.5 rounded-md outline-none text-sm","placeholder:text-sm"],t),...r})}function pe({className:t,ref:r,children:a,...s}){return e(c.List,{ref:r,className:d("max-h-80 scroll-py-8",t),...s,children:a})}function fe({className:t,ref:r,children:a,...s}){return e(c.Item,{ref:r,className:d("px-4 py-2 text-sm w-full aria-selected:bg-gray-100 inline-flex",t),...s,children:a})}const qe=p.Root,xe=p.Trigger;function ye({className:t,children:r,ref:a,...s}){return e(p.Portal,{children:e(p.Content,{ref:a,className:d("w-(--radix-popper-anchor-width) border border-gray-400 rounded-md shadow-sm bg-white",t),sideOffset:5,...s,children:r})})}const ve=R([{label:"Qui sommes-nous ?",to:"/about"},{label:"FAQ",to:"/faq"},{label:"Sources",to:"/sources"},{label:"Contact",to:"/contact"}]),be=q("app_components_header_tsx--signOutFn_createServerFn_handler","/_server",(t,r)=>C.__executeServer(t,r)),C=x({method:"POST"}).handler(be,async()=>{const t=N();t&&await b.api.signOut({headers:t.headers})});function we({user:t,queryClient:r}){const[a,s]=w(""),m=de(a,1e3),{data:f,isFetching:g}=L(ce(m));return e("header",{className:"px-16 py-3 border-b border-gray-200 backdrop-blur-sm",children:n("div",{className:"flex items-center justify-between",children:[e("nav",{children:n("ul",{className:"flex items-center gap-4",children:[e("li",{children:e(l,{to:"/",className:"text-sm font-light",children:"Annuaire TIH"})}),ve.map(i=>e("li",{children:e(l,{to:i.to,className:"text-sm font-light",activeProps:{className:"text-blue-700"},children:i.label})},i.to))]})}),n("div",{className:"flex items-center gap-4",children:[n(qe,{children:[e(xe,{asChild:!0,children:e("button",{type:"button",className:"text-start text-xs text-nowrap font-light px-4 border border-gray-400 rounded-sm bg-white w-80 h-8 focus-within:outline focus-within:outline-blue-500",children:"Rechercher un nom ou une activité..."})}),e(ye,{children:n(me,{shouldFilter:!1,className:"py-2",children:[e(ge,{value:a,onValueChange:s,placeholder:"Entrez un nom ou une activité..."}),e(ue,{alwaysRender:!0}),n(pe,{children:[!a&&e(y,{children:"Entrez au moins 3 caractères..."}),a&&g&&e(he,{children:"Loading..."}),a.length>=3&&!g&&e(y,{children:"Aucune entreprise trouvée"}),f?.map(i=>e(fe,{asChild:!0,children:e(l,{to:"/entreprises/$slug",params:{slug:i.slug},children:i.name})},i.id))]})]})})]}),e("a",{href:"https://linkedin.com/groups/13011531",target:"_blank",rel:"noopener noreferrer",className:"hover:text-blue-700 transition-colors",children:e(ee,{className:"size-5"})}),e(Ne,{user:t}),e(Te,{user:t}),e(Se,{user:t,queryClient:r})]})]})})}function Ne({user:t}){return t?null:e(l,{to:"/signup",className:"text-xs px-2 py-1 rounded-sm border border-gray-400",children:"Se référencer"})}function Te({user:t}){return t?null:e(l,{to:"/login",className:"text-xs px-2 py-1 rounded-sm border border-gray-400 cursor-pointer",children:"Login"})}function Se({user:t,queryClient:r}){const a=F(),{theme:s,onThemeLight:m,onThemeDark:f,onThemeSystem:g,setTheme:i}=T(),{isAdmin:k}=ie(),{mutate:I}=V({mutationFn:Y(C)});if(!t)return null;async function z(){I(void 0,{onSuccess:()=>{r.clear(),$.success("Vous êtes déconnecté"),a.invalidate(),a.navigate({to:"/"})}})}return n(o.Root,{children:[e(o.Trigger,{className:"rounded-full cursor-pointer",children:e(Ce,{user:t})}),e(o.Portal,{children:n(o.Content,{sideOffset:2,align:"end",className:"bg-white border rounded-sm border-gray-200 min-w-64 overflow-hidden p-1 shadow-xs dark:bg-gray-900 dark:border-gray-400",children:[n("div",{className:"flex flex-col p-2",children:[e("span",{className:"text-sm",children:t.name}),e("span",{className:"truncate text-xs",children:t.email})]}),e(o.Separator,{className:"h-px bg-gray-200 my-1 -mx-1"}),n(o.Group,{children:[e(o.Item,{asChild:!0,children:n(l,{to:"/compte/entreprises/create",className:"outline-none flex items-center gap-2 px-2 py-1.5 data-highlighted:bg-gray-100 select-none dark:data-highlighted:bg-gray-800",children:[e(ae,{className:"size-4"}),e("span",{className:"text-xs",children:"Référencer"})]})}),e(o.Item,{asChild:!0,children:n(l,{to:"/compte/entreprises",className:"outline-none flex items-center gap-2 px-2 py-1.5 data-highlighted:bg-gray-100 select-none dark:data-highlighted:bg-gray-800",children:[e(ne,{className:"size-4"}),e("span",{className:"text-xs",children:"Mes entreprises"})]})}),e(o.Item,{asChild:!0,children:n(l,{to:"/compte/preferences",className:"outline-none flex items-center gap-2 px-2 py-1.5 data-highlighted:bg-gray-100 select-none dark:data-highlighted:bg-gray-800",children:[e(re,{className:"size-4"}),e("span",{className:"text-xs",children:"Mon compte"})]})}),k?e(o.Item,{asChild:!0,children:n(l,{to:"/admin/dashboard",className:"outline-none flex items-center gap-2 px-2 py-1.5 data-highlighted:bg-gray-100 select-none dark:data-highlighted:bg-gray-800",children:[e(oe,{className:"size-4"}),e("span",{className:"text-xs",children:"Admin dashboard"})]})}):null]}),e(o.Separator,{className:"h-px bg-gray-200 my-1 -mx-1"}),n(o.Group,{children:[e(o.Label,{className:"text-sm font-light px-2 py-1.5",children:"Thème"}),n(o.RadioGroup,{value:s??"system",onValueChange:i,children:[n(o.RadioItem,{value:"light",className:"text-xs py-1.5 ps-8 select-none outline-none data-highlighted:bg-gray-100 relative flex items-center dark:data-highlighted:bg-gray-800",onSelect:()=>m(),children:[e(o.ItemIndicator,{className:"absolute start-2",children:e("span",{className:"size-2 rounded-full flex bg-gray-400"})}),"Light"]}),n(o.RadioItem,{value:"dark",className:"text-xs py-1.5 ps-8 select-none outline-none data-highlighted:bg-gray-100 relative flex items-center dark:data-highlighted:bg-gray-800",onSelect:()=>f(),children:[e(o.ItemIndicator,{className:"absolute start-2",children:e("span",{className:"size-2 rounded-full flex bg-gray-400"})}),"Dark"]}),n(o.RadioItem,{value:"system",className:"text-xs py-1.5 ps-8 select-none outline-none data-highlighted:bg-gray-100 relative flex items-center dark:data-highlighted:bg-gray-800",onSelect:()=>g(),children:[e(o.ItemIndicator,{className:"absolute start-2",children:e("span",{className:"size-2 rounded-full flex bg-gray-400"})}),"System"]})]})]}),e(o.Separator,{className:"h-px bg-gray-200 my-1 -mx-1"}),e(o.Group,{children:n(o.Item,{onSelect:()=>z(),className:"text-xs px-2 py-1.5 outline-none cursor-pointer flex items-center gap-2 data-highlighted:bg-gray-100 dark:data-highlighted:bg-gray-800",children:[e(te,{className:"size-4"}),e("span",{children:"Se déconnecter"})]})})]})})]})}function Ce({user:t}){if(!t)return null;const r=t.name?.split(" ").map(a=>a[0]).join("");return t.image?n(h.Root,{className:"size-8 rounded-full",children:[e(h.Image,{src:t.image,alt:t.name,className:"size-full rounded-full"}),e(h.Fallback,{className:"size-full leading-1",children:r})]}):e(h.Root,{className:"size-8 rounded-full border border-gray-200 flex",children:e(h.Fallback,{className:"size-full leading-1 text-xs grid place-items-center text-blue-500",children:r})})}const _e="/_server/assets/app-h7mye6s-.css",ke=q("app_routes_root_tsx--getSession_createServerFn_handler","/_server",(t,r)=>_.__executeServer(t,r)),_=x({method:"GET"}).handler(ke,async()=>{const t=N();return t?await b.api.getSession({headers:t.headers}):null}),Ie=v({queryKey:["user","session"],queryFn:({signal:t})=>_({signal:t})});function ze(){return e(Ve,{children:e(H,{})})}const Le=M()({head:()=>({meta:[{charSet:"utf-8"},{name:"viewport",content:"width=device-width, initial-scale=1"},{title:"Annuaire TIH"}],links:[{rel:"stylesheet",href:_e}]}),beforeLoad:async({context:t})=>({user:(await t.queryClient.fetchQuery(Ie))?.user}),notFoundComponent:()=>e("div",{children:"Not found"}),component:ze});function Ve({children:t}){const{user:r,queryClient:a}=Le.useRouteContext(),{setTheme:s}=T();return A(()=>{s(localStorage.getItem("theme")||"system")},[s]),n("html",{lang:"fr",suppressHydrationWarning:!0,children:[n("head",{children:[e(E,{}),e(O,{children:"document.documentElement.dataset.theme = localStorage.theme === 'dark' || (!('theme' in localStorage) && matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'"})]}),n("body",{className:"font-sans text-gray-700 isolate dark:bg-gray-900 dark:text-gray-100",children:[e(we,{user:r,queryClient:a}),t,e(G,{}),e(Z,{buttonPosition:"bottom-left"}),e(B,{})]})]})}export{ke as getSession_createServerFn_handler};
